<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Эмоциональный интеллект</title>
   
    <!-- Подключение файла для инициализации чата -->
    <script src="{{ url_for('static', filename='js/chat-init.js') }}"></script>
    <!-- Подключение скрипта для исправления первого сообщения чата -->
    <script src="{{ url_for('static', filename='js/fix-first-message.js') }}"></script>
    <!-- Подключение скрипта для исправления стиля уточняющих вопросов -->
    <script src="{{ url_for('static', filename='js/fix-follow-up-style.js') }}"></script>
    <!-- Проверка загрузки chat-init.js -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Обновляем обработчики только если chat-init.js загружен
            if (typeof window.handleSendMessage === 'function') {
                console.log("✅ Файл chat-init.js успешно загружен, используем его функции");
                
                // Назначаем обработчики напрямую на глобальные функции
                const chatSend = document.getElementById('chatSend');
                const chatInput = document.getElementById('chatInput');
                
                if (chatSend) {
                    chatSend.onclick = window.handleSendMessage;
                    console.log("✅ Установлен обработчик клика для кнопки отправки");
                }
                
                if (chatInput) {
                    chatInput.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            window.handleSendMessage();
                        }
                    };
                    console.log("✅ Установлен обработчик нажатия Enter для поля ввода");
                }
                
                // Если есть кнопка открытия чата, назначаем обработчик
                const chatButton = document.getElementById('journalCardChat');
                if (chatButton && typeof window.openChat === 'function') {
                    chatButton.onclick = window.openChat;
                    console.log("✅ Установлен обработчик для кнопки открытия чата");
                }
                
                // Если есть кнопка закрытия чата, назначаем обработчик
                const chatClose = document.getElementById('chatClose');
                if (chatClose && typeof window.closeChat === 'function') {
                    chatClose.onclick = window.closeChat;
                    console.log("✅ Установлен обработчик для кнопки закрытия чата");
                }
                
                console.log("✅ Файл chat-init.js загружен успешно");
            } else {
                console.log("❌ ОШИБКА: Файл chat-init.js не загружен. Чат будет работать в упрощенном режиме.");
            }
        });
    </script>
    <!-- Подключение официального Telegram Mini Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}" defer></script>
    <script>
        // Устанавливаем cookie при загрузке страницы
        document.cookie = "tgWebAppData=true; path=/; max-age=3600";
        
        // Скрываем блок выбора состояния при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Скрываем блок выбора состояния
            const stateSelectionContainer = document.querySelector('.state-selection-container');
            if (stateSelectionContainer) {
                stateSelectionContainer.style.display = 'none';
            }
            
            // Скрываем блок с календарем настроения
            const streakContainer = document.querySelector('.streak-container');
            if (streakContainer) {
                streakContainer.style.display = 'none';
            }
        });
        
        // Дополнительная проверка Telegram WebApp API
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка Telegram WebApp API
            const isTelegramWebAppAvailable = window.Telegram && window.Telegram.WebApp;
            const tg = isTelegramWebAppAvailable ? window.Telegram.WebApp : null;
            
            // --- НАЧАЛО ИЗМЕНЕНИЯ: Обработчик изменения viewport ---
            if (tg) {
                const chatContainer = document.getElementById('chatContainer');
                
                const adjustViewportHeight = () => {
                    if (chatContainer && tg.viewportHeight) {
                         // Устанавливаем высоту контейнера равной видимой высоте viewport
                         // Вычитаем небольшое значение, если нужно учесть другие элементы или отступы
                         // Можно убрать ` - 1`, если не нужно
                        chatContainer.style.height = `${tg.viewportHeight}px`;
                        console.log(`Viewport changed. Set chat container height to: ${tg.viewportHeight}px`);
                    }
                };

                // Вызываем при загрузке и при изменении viewport
                tg.onEvent('viewportChanged', adjustViewportHeight);
                // Вызываем также при инициализации на случай, если viewport уже изменен
                //adjustViewportHeight(); 
                
                // Расширяем видимую область, если возможно
               // tg.expand();
            }
            // --- КОНЕЦ ИЗМЕНЕНИЯ ---
            
            // Получаем имя пользователя для приветствия
            let userName = "друг";
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userName = tg.initDataUnsafe.user.first_name || "друг";
            }
            
            // Устанавливаем имя пользователя в приветствии
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = userName;
            }
            
            // Принудительно устанавливаем светлую тему, независимо от настроек Telegram
            if (tg && tg.themeParams) {
                // Переопределяем цвета темы на светлые
                document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-color', '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                
                // Принудительно устанавливаем светлый фон для body
                document.body.style.backgroundColor = '#ffffff';
                document.body.style.color = '#000000';
            }
            
            // Cloud-like floating animation for background image
            const parallaxImage = document.getElementById('parallaxImage');
            if (parallaxImage) {
                // Initial position variables
                let posX = 0;
                let posY = 0;
                let directionX = 1;  // 1 for right, -1 for left
                let directionY = 1;  // 1 for down, -1 for up
                
                // Animation speeds (smaller = slower)
                let speedX = 0.03;
                let speedY = 0.02;
                
                // Movement range
                const maxX = 15;  // max pixels to move horizontally
                const maxY = 12;   // увеличиваем вертикальный диапазон для большей высоты элемента
                
                // Time tracking for smooth speed changes
                let time = 0;
                const speedChangeInterval = 5000; // ms
                
                // Animation function
                function animateBackground() {
                    // Update time
                    time += 16; // Approximately 16ms per frame at 60fps
                    
                    // Occasionally vary the speed slightly to make movement more natural
                    if (time >= speedChangeInterval) {
                        // Slightly randomize speeds
                        speedX = 0.02 + Math.random() * 0.02; // Between 0.02 and 0.04
                        speedY = 0.01 + Math.random() * 0.02; // Between 0.01 and 0.03
                        time = 0;
                    }
                    
                    // Update positions with slight sinusoidal movement for more natural flow
                    posX += speedX * directionX;
                    posY += speedY * directionY * (0.9 + Math.sin(time/1000) * 0.1);
                    
                    // Change direction when reaching limits
                    if (Math.abs(posX) > maxX) {
                        directionX *= -1;
                    }
                    
                    if (Math.abs(posY) > maxY) {
                        directionY *= -1;
                    }
                    
                    // Apply the new position
                    parallaxImage.style.transform = `translateX(${-posX}px) translateY(${-posY}px)`;
                    
                    // Continue animation
                    requestAnimationFrame(animateBackground);
                }
                
                // Start animation
                animateBackground();
            }
            
            // Обработчики для карточек состояния
            document.addEventListener('DOMContentLoaded', function() {
                const normalStateCard = document.getElementById('normalStateCard');
                const anxiousStateCard = document.getElementById('anxiousStateCard');
                const speechBubble = document.querySelector('.speech-bubble');
                const dayRatingContainer = document.getElementById('dayRatingContainer');
                
                if (normalStateCard && anxiousStateCard && speechBubble) {
                    // Обработчик для карточки "Всё нормально"
                    normalStateCard.addEventListener('click', function() {
                        // Открываем окно чата
                        openChat();
                    });
                    
                    // Обработчик для карточки "Чувствую тревогу"
                    anxiousStateCard.addEventListener('click', function() {
                        // Открываем окно чата
                        openChat();
                    });
                }
            });
            
            // Генерация и наполнение календаря настроения
            function generateMoodCalendar() {
                const moodCalendar = document.getElementById('moodCalendar');
                if (!moodCalendar) return;
                
                // Очищаем календарь
                moodCalendar.innerHTML = '';
                
                // Получение данных о настроении пользователя из базы данных
                getMoodData().then(moodData => {
                    // Создаем 4-недельный обзор
                    create4WeekSnapshot(moodData, moodCalendar);
                });
            }
            
            // Функция для получения данных настроения из базы данных
            async function getMoodData() {
                try {
                    // Запрашиваем данные о настроении с сервера с использованием fetchWithAuth
                    const url = '/api/mood-data?soft_validation=1';
                    console.log('Запрашиваем данные настроения с URL:', url);
                    
                    const response = await fetchWithAuth(url);
                    if (!response.ok) {
                        console.warn('Сервер вернул ошибку:', response.status, response.statusText);
                        throw new Error('Ошибка при получении данных о настроении: ' + response.status);
                    }
                    
                    const data = await response.json();
                    console.log('Получены данные о настроении:', data);
                    
                    // Преобразуем даты из строк в объекты Date
                    if (data.firstVisitDate) {
                        data.firstVisitDate = new Date(data.firstVisitDate);
                    } else {
                        // Если первое посещение не определено, используем дату 28 дней назад
                        const firstVisit = new Date();
                        firstVisit.setDate(firstVisit.getDate() - 28);
                        data.firstVisitDate = firstVisit;
                    }
                    
                    if (data.moodEntries && Array.isArray(data.moodEntries)) {
                        data.moodEntries = data.moodEntries.map(entry => ({
                            date: new Date(entry.date),
                            rating: entry.rating
                        }));
                    } else {
                        data.moodEntries = [];
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Ошибка при получении данных о настроении:', error);
                    
                    // В случае ошибки, возвращаем пустой объект с базовыми данными
                    const defaultData = {
                        firstVisitDate: new Date(new Date().setDate(new Date().getDate() - 28)),
                        moodEntries: [],
                        success: true // Добавляем для совместимости с проверяющим кодом
                    };
                    
                    return defaultData;
                }
            }
            
            // Функция для создания 4-недельного обзора
            function create4WeekSnapshot(moodData, container) {
                // Получаем текущую дату
                const today = new Date();
                // Получаем дату первого посещения или дату 28 дней назад, если нет данных
                const firstVisitDate = moodData.firstVisitDate || new Date(today);
                firstVisitDate.setDate(firstVisitDate.getDate() - 27); // 28 дней включая сегодня
                
                // Устанавливаем начало на понедельник той недели, в которую попадает firstVisitDate
                const startDay = new Date(firstVisitDate);
                const dayOfWeek = startDay.getDay();
                // getDay() возвращает 0 для воскресенья, поэтому корректируем
                const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startDay.setDate(startDay.getDate() - daysToSubtract);
                
                // Создаем массив для 28 дней (4 недели)
                const days = [];
                const currentDay = new Date(startDay);
                
                // Заполняем массив данными для 28 дней
                for (let i = 0; i < 28; i++) {
                    // Находим запись о настроении для текущего дня, если она существует
                    const moodEntry = moodData.moodEntries.find(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === currentDay.getFullYear() && 
                               entryDate.getMonth() === currentDay.getMonth() && 
                               entryDate.getDate() === currentDay.getDate();
                    });
                    
                    // Определяем, является ли день будущим или прошедшим
                    const isFutureDay = currentDay > today;
                    
                    // Добавляем информацию о дне
                    days.push({
                        day: currentDay.getDate(),
                        date: new Date(currentDay),
                        isFutureDay: isFutureDay,
                        hasRating: !!moodEntry,
                        rating: moodEntry ? moodEntry.rating : null
                    });
                    
                    // Переходим к следующему дню
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                
                // Отображаем дни в календаре
                days.forEach(dayData => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    // Применяем нужный класс в зависимости от типа дня
                    if (dayData.isFutureDay) {
                        // Будущие дни с белым фоном
                        dayElement.classList.add('future');
                    } else if (dayData.hasRating) {
                        // Дни с оценкой
                        dayElement.classList.add('visited');
                        
                        // Определяем класс в зависимости от оценки
                        if (dayData.rating <= 3) {
                            dayElement.classList.add('rating-low');
                        } else if (dayData.rating <= 7) {
                            dayElement.classList.add('rating-medium');
                        } else {
                            dayElement.classList.add('rating-high');
                        }
                        
                        // Добавляем всплывающую подсказку с информацией
                        const tooltip = document.createElement('span');
                        tooltip.className = 'calendar-tooltip';
                        
                        // Форматируем дату для подсказки
                        const formattedDate = new Intl.DateTimeFormat('ru-RU', { 
                            day: 'numeric', 
                            month: 'long' 
                        }).format(dayData.date);
                        
                        tooltip.textContent = `${formattedDate}: Оценка ${dayData.rating}`;
                        dayElement.appendChild(tooltip);
                    }
                    // Прошедшие неоцененные дни остаются серыми (базовый стиль)
                    
                    container.appendChild(dayElement);
                });
            }
            
            // Запускаем генерацию календаря при загрузке страницы
            // generateMoodCalendar(); // Отключено, календарь скрыт
            
            // Удалены все функции и обработчики, связанные с оценкой дня
            
            // Функции для работы с чатом
            const chatOverlay = document.getElementById('chatOverlay');
            const chatClose = document.getElementById('chatClose');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            // Массив вопросов для последовательного задавания
            const chatQuestions = [
                {
                    id: "situation",
                    text: "Опишите событие, вызвавшее сильные эмоции. Где, когда, с кем это произошло?"
                },
                {
                    id: "thoughts",
                    text: "Какие мысли пришли вам в голову в этот момент?"
                },
                {
                    id: "emotions",
                    text: "Какие эмоции вы испытывали? Выберите из предложенных вариантов."
                },
                {
                    id: "intensity",
                    text: "Выберите интенсивность этой эмоции от 1 до 10."
                },
                {
                    id: "body",
                    text: "Опишите, как отреагировало ваше тело (учащенное сердцебиение, напряжение, потливость и т.д.)"
                },
                {
                    id: "evidenceFor",
                    text: "Есть ли реальные доказательства того, что ваша мысль соответствует действительности?"
                },
                {
                    id: "evidenceAgainst",
                    text: "Есть ли факты, которые опровергают вашу мысль?"
                },
                {
                    id: "reframe",
                    text: "Как можно переосмыслить эту ситуацию более объективно?"
                },
                {
                    id: "emotionChange",
                    text: "Как изменилась ваша эмоция после переоценки ситуации? Оцените от 1 до 10."
                },
                {
                    id: "futurePlan",
                    text: "Что можно сделать по-другому в будущем, чтобы справиться с подобной ситуацией?"
                }
            ];
            
            // Хранилище ответов пользователя
            let userResponses = {};
            
            // ВАЖНО: Инициализация currentQuestionIndex здесь
            let currentQuestionIndex = 0;
            
            // Функция для анализа ответов пользователя и предложения эмоций
            async function analyzeUserResponses() {
                console.log('Анализируем ответы пользователя локально без API');
                
                // Собираем предыдущие ответы пользователя
                const situation = userResponses['situation'] || "Не указано";
                const thoughts = userResponses['thoughts'] || "Не указано";
                
                // Простой анализ на основе ключевых слов
                const combinedText = (situation + ' ' + thoughts).toLowerCase();
                
                if (combinedText.includes('ссора') || combinedText.includes('конфликт') || 
                    combinedText.includes('спор') || combinedText.includes('обида')) {
                    return ['Гнев', 'Обида', 'Разочарование', 'Раздражение', 'Беспомощность'];
                } else if (combinedText.includes('экзамен') || combinedText.includes('тест') || 
                           combinedText.includes('выступление') || combinedText.includes('презентация')) {
                    return ['Тревога', 'Страх', 'Напряжение', 'Неуверенность', 'Волнение'];
                } else if (combinedText.includes('потеря') || combinedText.includes('расставание') || 
                           combinedText.includes('прощание') || combinedText.includes('утрата')) {
                    return ['Грусть', 'Печаль', 'Тоска', 'Одиночество', 'Опустошенность'];
                } else if (combinedText.includes('успех') || combinedText.includes('победа') || 
                           combinedText.includes('достижение') || combinedText.includes('награда')) {
                    return ['Радость', 'Гордость', 'Восторг', 'Удовлетворение', 'Воодушевление'];
                } else if (combinedText.includes('неожиданно') || combinedText.includes('сюрприз') || 
                           combinedText.includes('внезапно') || combinedText.includes('неожиданность')) {
                    return ['Удивление', 'Шок', 'Изумление', 'Растерянность', 'Любопытство'];
                } else {
                    // Если не удалось определить по ключевым словам, используем стандартный набор
                    return ['Радость', 'Грусть', 'Страх', 'Гнев', 'Удивление'];
                }
            }
            
            // Функция для создания кнопок выбора эмоций
            function createEmotionButtons(emotions) {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("❌ Элемент chatMessages не найден!");
                    return;
                }
                
                // Создаем контейнер для сообщения
                const message = document.createElement('div');
                message.className = 'message-wrapper bot-message';
                
                // Создаем HTML для кнопок эмоций
                let messageHTML = `
                    <div class="avatar bot-avatar">
                        <div class="avatar-inner">🤖</div>
                    </div>
                    <div class="message-container">
                        <div class="message-text">
                            <p>Выберите одну из этих эмоций:</p>
                            <div class="emotion-buttons">
                `;
                
                // Добавляем кнопки эмоций
                emotions.forEach(emotion => {
                    messageHTML += `<button class="emotion-button">${emotion}</button>`;
                });
                
                // Закрываем HTML-теги
                messageHTML += `
                            </div>
                        </div>
                        <div class="message-time">${getCurrentTime ? getCurrentTime() : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                
                // Устанавливаем HTML в элемент сообщения
                message.innerHTML = messageHTML;
                
                // Добавляем сообщение в чат
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                message.scrollIntoView({ behavior: 'smooth' });
                
                // Добавляем обработчики для кнопок эмоций
                const emotionButtons = message.querySelectorAll('.emotion-button');
                emotionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // Выделяем выбранную кнопку
                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // Получаем выбранную эмоцию
                        const selectedEmotion = this.textContent;
                        
                        // Добавляем выбранную эмоцию как ответ пользователя
                        if (typeof addUserMessage === 'function') {
                            addUserMessage(selectedEmotion);
                        } else if (typeof window.addUserMessage === 'function') {
                            window.addUserMessage(selectedEmotion);
                        } else {
                            // Создаем сообщение пользователя вручную, если функция не найдена
                            const userMsg = document.createElement('div');
                            userMsg.className = 'message-wrapper user-message';
                            userMsg.innerHTML = `
                                <div class="message-container">
                                    <div class="message-text">${selectedEmotion}</div>
                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            `;
                            chatMessages.appendChild(userMsg);
                            userMsg.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        // Сохраняем ответ в глобальном массиве userResponses
                        if (typeof window.userResponses === 'object') {
                            window.userResponses['emotions'] = selectedEmotion;
                        } else {
                            console.error("❌ Ошибка: window.userResponses не является объектом!");
                        }
                        
                        // Увеличиваем индекс текущего вопроса
                        window.currentQuestionIndex++;
                        
                        // Показываем следующий вопрос через функцию из chat-init.js
                            setTimeout(() => {
                            if (typeof window.showNextQuestion === 'function') {
                                window.showNextQuestion();
                            } else if (typeof showNextQuestion === 'function') {
                                showNextQuestion();
                        } else {
                                console.error("❌ Функция showNextQuestion не найдена!");
                            }
                        }, 500);
                    });
                });
                
                return message;
            }
            
            // Добавляем функцию в глобальный объект window
            window.createEmotionButtons = createEmotionButtons;
            
            // Функция для открытия чата - УПРОЩЕННАЯ ВЕРСИЯ
            function openChat() {
                console.log("🛑 ВЫЗВАНА ЛОКАЛЬНАЯ ФУНКЦИЯ openChat");
                
                // Проверяем, существует ли глобальная функция openChat
                if (typeof window.openChat === 'function') {
                    console.log("🛑 Найдена глобальная функция openChat, используем ее");
                    window.openChat();
                    return;
                }
                
                console.log("🛑 Используем локальную функцию openChat, т.к. глобальная не найдена");
                
                const chatOverlay = document.getElementById('chatOverlay');
                const chatMessages = document.getElementById('chatMessages');
                const chatInput = document.getElementById('chatInput');
                const chatSend = document.getElementById('chatSend');
                
                if (!chatOverlay || !chatMessages || !chatInput || !chatSend) {
                    console.error("Элементы чата не найдены:", {
                        chatOverlay: !!chatOverlay,
                        chatMessages: !!chatMessages,
                        chatInput: !!chatInput,
                        chatSend: !!chatSend
                    });
                    return;
                }
                
                // Активируем оверлей
                chatOverlay.classList.add('active');
                
                // Показываем контейнер чата
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.style.display = 'block';
                    chatContainer.style.opacity = '1';
                }
                
                // Очищаем предыдущие сообщения
                chatMessages.innerHTML = '';
                
                // Очищаем предыдущие ответы
                userResponses = {};
                
                // Также сбрасываем глобальные ответы
                if (typeof window === 'object') {
                    window.userResponses = {};
                    console.log('✅ Глобальный объект window.userResponses сброшен');
                }
                
                // Сбрасываем индекс вопроса
                currentQuestionIndex = 0;
                
                // Также сбрасываем глобальный индекс
                if (typeof window === 'object') {
                    window.currentQuestionIndex = 0;
                    console.log('✅ Глобальный индекс window.currentQuestionIndex сброшен');
                }
                
                console.log("🛑 ИНДЕКС СБРОШЕН:", currentQuestionIndex);
                
                // Добавляем первый вопрос
                const firstQuestion = document.createElement('div');
                firstQuestion.className = 'message message-bot';
                firstQuestion.textContent = chatQuestions[0].text;
                chatMessages.appendChild(firstQuestion);
                
                console.log("🛑 ДОБАВЛЕН ПЕРВЫЙ ВОПРОС:", chatQuestions[0].text);
                
                // Убедимся, что кнопка отправки имеет обработчик
                chatSend.onclick = function() {
                    console.log("🛑 КНОПКА ОТПРАВКИ НАЖАТА");
                    if (typeof window.handleSendMessage === 'function') {
                        console.log("🛑 Вызываем глобальную функцию window.handleSendMessage из обработчика кнопки");
                        window.handleSendMessage();
                    } else {
                        console.log("🛑 Вызываем локальную функцию handleSendMessage из обработчика кнопки");
                        handleSendMessage();
                    }
                };
                
                // Убедимся, что поле ввода реагирует на Enter
                chatInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        console.log("🛑 НАЖАТА КЛАВИША ENTER");
                        if (typeof window.handleSendMessage === 'function') {
                            console.log("🛑 Вызываем глобальную функцию window.handleSendMessage из обработчика клавиши Enter");
                            window.handleSendMessage();
                        } else {
                            console.log("🛑 Вызываем локальную функцию handleSendMessage из обработчика клавиши Enter");
                            handleSendMessage();
                        }
                    }
                };
            }
            
            // Отдельная функция для обработки нажатия Enter
            function handleEnterPress(e) {
                if (e.key === 'Enter') {
                    console.log("Нажата клавиша Enter в поле ввода");
                    e.preventDefault(); // Предотвращаем стандартное поведение
                    if (typeof window.handleSendMessage === 'function') {
                        console.log("🛑 Вызываем глобальную функцию window.handleSendMessage из handleEnterPress");
                        window.handleSendMessage();
                    } else {
                        console.log("🛑 Вызываем локальную функцию handleSendMessage из handleEnterPress");
                        handleSendMessage();
                    }
                }
            }
            
            // Функция для закрытия чата
            function closeChat() {
                // Применяем анимацию исчезновения к контейнеру
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    // Анимируем исчезновение
                    chatContainer.style.opacity = '0';
                    chatContainer.style.transform = 'translateY(20px)';
                    
                    // Убираем класс active у оверлея после анимации
                    setTimeout(() => {
                        chatOverlay.classList.remove('active');
                        // Сброс стилей для следующего открытия
                        chatContainer.style.transition = '';
                    }, 300);
                } else {
                    // Если контейнер не найден, просто скрываем оверлей
                chatOverlay.classList.remove('active');
                }
                
                console.log('Чат закрыт через функцию closeChat');
            }
            
            // Функция для добавления сообщения от бота
            function addBotMessage(text) {
                console.log("ДОБАВЛЯЮ СООБЩЕНИЕ ОТ БОТА:", text);
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("Элемент chatMessages не найден");
                    return;
                }
                
                const message = document.createElement('div');
                message.className = 'message message-bot';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Если это вопрос про интенсивность эмоции, сразу показываем слайдер
                if (text === chatQuestions[3].text || text === chatQuestions[8].text) {
                    setTimeout(() => {
                        createEmotionIntensitySlider();
                    }, 300);
                }
            }
            
            // Функция для добавления сообщения от пользователя
            function addUserMessage(text) {
                console.log("ДОБАВЛЯЮ СООБЩЕНИЕ ОТ ПОЛЬЗОВАТЕЛЯ:", text);
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("Элемент chatMessages не найден");
                    return;
                }
                
                const message = document.createElement('div');
                message.className = 'message message-user';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // ЕДИНАЯ функция для обработки отправки сообщения
            function handleSendMessage() {
                console.log("🛑 ЛОКАЛЬНАЯ ВЕРСИЯ handleSendMessage ВЫЗВАНА");
                console.log("🛑 window.handleSendMessage существует?", typeof window.handleSendMessage === 'function');
                
                // Если есть глобальная функция handleSendMessage из chat-init.js, используем ее
                if (typeof window.handleSendMessage === 'function') {
                    console.log("🛑 Вызываем глобальную функцию window.handleSendMessage");
                    window.handleSendMessage();
                    return;
                }
                
                console.log("Используется локальная версия handleSendMessage, а не глобальная из chat-init.js");
                console.log("🛑 ОБРАБОТЧИК ВЫЗВАН, текущий индекс:", currentQuestionIndex);
                
                const chatInput = document.getElementById('chatInput');
                const chatMessages = document.getElementById('chatMessages');
                const userInput = document.getElementById('userInput');
                
                // Определяем поле ввода в зависимости от того, какое найдено
                const inputField = chatInput || userInput;
                
                // Проверяем наличие элементов
                if (!inputField || !chatMessages) {
                    console.error("Элементы чата не найдены:", {
                        inputField: !!inputField,
                        chatMessages: !!chatMessages
                    });
                    return;
                }
                
                // Получаем текст из поля ввода
                const text = inputField.value.trim();
                
                // Если текст пустой, не делаем ничего
                if (!text) {
                    console.log("Сообщение пустое");
                    return;
                }
                
                console.log("🛑 ПОЛУЧЕН ТЕКСТ:", text);
                
                // Добавляем сообщение пользователя
                addUserMessage(text);
                
                // Сохраняем ответ в объект userResponses
                const currentQuestion = chatQuestions[currentQuestionIndex];
                if (currentQuestion && currentQuestion.id) {
                    console.log(`🔄 Сохраняем ответ для вопроса типа ${currentQuestion.id}`);
                    
                    // Используем глобальный объект window.userResponses для совместимости
                    if (typeof window.userResponses === 'object') {
                        window.userResponses[currentQuestion.id] = text;
                        console.log(`✅ Ответ сохранен в window.userResponses['${currentQuestion.id}']`);
                    } else {
                        console.error("❌ Ошибка: window.userResponses не является объектом!");
                    }
                    
                    // Также сохраняем в локальный userResponses для обратной совместимости
                    userResponses[currentQuestion.id] = text;
                } else {
                    console.error("❌ Не удалось определить тип текущего вопроса!");
                }
                
                // Очищаем поле ввода
                inputField.value = '';
                
                // Увеличиваем индекс вопроса
                currentQuestionIndex++;
                
                console.log("🛑 ТЕКУЩИЙ ИНДЕКС:", currentQuestionIndex);
                
                // Показываем следующий вопрос через небольшую задержку
                setTimeout(function() {
                    console.log("🛑 ПОДГОТОВКА К ОТОБРАЖЕНИЮ ВОПРОСА", currentQuestionIndex);
                    
                    // Если это второй вопрос (индекс 1), с обычным текстом
                    if (currentQuestionIndex === 1) {
                        console.log("🛑 ПОКАЗЫВАЕМ ВТОРОЙ ВОПРОС");
                        addBotMessage(chatQuestions[currentQuestionIndex].text);
                    }
                    // Если это третий вопрос (индекс 2), с выбором эмоций
                    else if (currentQuestionIndex === 2) {
                        console.log("🛑 ПОКАЗЫВАЕМ ТРЕТИЙ ВОПРОС С ЭМОЦИЯМИ");
                        // Добавляем сообщение с вопросом про эмоции
                        addBotMessage(chatQuestions[currentQuestionIndex].text);
                        
                        // Анализируем ответы и показываем кнопки эмоций
                        setTimeout(async () => {
                            try {
                                // Пытаемся получить список эмоций на основе предыдущих ответов
                                const emotions = ['Радость', 'Грусть', 'Страх', 'Гнев', 'Тревога', 'Разочарование', 'Удивление', 'Стыд', 'Вина', 'Любопытство'];
                                
                                // Создаем блок с кнопками эмоций
                                const emotionBlock = document.createElement('div');
                                emotionBlock.className = 'message message-bot';
                                
                                let buttonsHTML = '<div class="emotion-buttons">';
                                emotions.forEach(emotion => {
                                    buttonsHTML += `<button class="emotion-button">${emotion}</button>`;
                                });
                                buttonsHTML += '</div>';
                                
                                emotionBlock.innerHTML = buttonsHTML;
                                chatMessages.appendChild(emotionBlock);
                                
                                // Прокручиваем чат вниз
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                
                                // Добавляем обработчики для кнопок эмоций
                                const emotionButtons = emotionBlock.querySelectorAll('.emotion-button');
                                emotionButtons.forEach(button => {
                                    button.addEventListener('click', function() {
                                        // Выделяем выбранную кнопку
                                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                                        this.classList.add('selected');
                                        
                                        // Получаем выбранную эмоцию
                                        const selectedEmotion = this.textContent;
                                        
                                        // Добавляем выбранную эмоцию как ответ пользователя
                                        if (typeof addUserMessage === 'function') {
                                            addUserMessage(selectedEmotion);
                                        } else if (typeof window.addUserMessage === 'function') {
                                            window.addUserMessage(selectedEmotion);
                                        } else {
                                            // Создаем сообщение пользователя вручную, если функция не найдена
                                            const userMsg = document.createElement('div');
                                            userMsg.className = 'message-wrapper user-message';
                                            userMsg.innerHTML = `
                                                <div class="message-container">
                                                    <div class="message-text">${selectedEmotion}</div>
                                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                </div>
                                            `;
                                            chatMessages.appendChild(userMsg);
                                            userMsg.scrollIntoView({ behavior: 'smooth' });
                                        }
                                        
                                        // Сохраняем ответ в глобальном массиве userResponses
                                        if (typeof window.userResponses === 'object') {
                                            window.userResponses['emotions'] = selectedEmotion;
                                        } else {
                                            console.error("❌ Ошибка: window.userResponses не является объектом!");
                                        }
                                        
                                        // Увеличиваем индекс текущего вопроса
                                        window.currentQuestionIndex++;
                                        
                                        setTimeout(() => {
                                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                                        }, 500);
                                    });
                                });
                            } catch (error) {
                                console.error('Ошибка при создании кнопок эмоций:', error);
                                
                                // В случае ошибки переходим к следующему вопросу
                                currentQuestionIndex++;
                                addBotMessage(chatQuestions[currentQuestionIndex].text);
                            }
                        }, 500);
                    }
                    // Для всех остальных вопросов
                    else {
                        console.log("🛑 ПОКАЗЫВАЕМ ОБЫЧНЫЙ ВОПРОС:", currentQuestionIndex);
                        // Проверяем, есть ли еще вопросы
                        console.log('🔍 ПРОВЕРКА УСЛОВИЯ ЗАВЕРШЕНИЯ В INDEX.HTML:');
                        console.log(`   - currentQuestionIndex = ${currentQuestionIndex}`);
                        console.log(`   - chatQuestions.length = ${chatQuestions.length}`);
                        console.log(`   - Условие: ${currentQuestionIndex < chatQuestions.length}`);
                        
                        if (currentQuestionIndex < chatQuestions.length) {
                            // Добавляем следующий вопрос
                            console.log(`🔄 Добавляем вопрос #${currentQuestionIndex}: "${chatQuestions[currentQuestionIndex].text}"`);
                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                            
                            // Если это вопрос об интенсивности эмоции
                            if (currentQuestionIndex === 8) {
                                setTimeout(() => {
                                    createEmotionIntensitySlider();
                                }, 300);
                            }
                        } else {
                            console.log("🎯 УСЛОВИЕ ЗАВЕРШЕНИЯ ВЫПОЛНЕНО В INDEX.HTML!");
                            // Если вопросы закончились, показываем финальное сообщение
                            addBotMessage("Спасибо за ваши ответы! Этот анализ помог вам лучше понять свои эмоции и мысли. Вы можете закрыть окно чата или начать новый анализ.");
                            
                            // ДОБАВЛЯЕМ СОХРАНЕНИЕ РЕЗУЛЬТАТОВ
                            console.log('🔴 ВЫЗОВ СОХРАНЕНИЯ РЕЗУЛЬТАТОВ ИЗ INDEX.HTML (второй блок)');
                            
                            // Добавляем подробное логирование userResponses
                            console.log('🔍 ДИАГНОСТИКА userResponses (второй блок):');
                            console.log('typeof window.userResponses:', typeof window.userResponses);
                            console.log('Является ли массивом:', Array.isArray(window.userResponses));
                            console.log('Все ключи в userResponses:', Object.keys(window.userResponses));
                            console.log('Значения в userResponses:', window.userResponses);
                            
                            setTimeout(() => {
                                if (typeof window.saveAnalysisResults === 'function') {
                                    console.log('🔴 ФУНКЦИЯ saveAnalysisResults НАЙДЕНА, ВЫЗЫВАЕМ...');
                                    window.saveAnalysisResults()
                                        .then(result => {
                                            console.log('🔴 РЕЗУЛЬТАТЫ УСПЕШНО СОХРАНЕНЫ:', result);
                                        })
                                        .catch(error => {
                                            console.error('🔴 ОШИБКА ПРИ СОХРАНЕНИИ РЕЗУЛЬТАТОВ:', error);
                                        });
                                } else {
                                    console.error('🔴 ФУНКЦИЯ saveAnalysisResults НЕ НАЙДЕНА!');
                                }
                            }, 1000);
                        }
                    }
                }, 500);
            }
            
            // Обработчики событий для чата
            if (document.getElementById('chatClose')) {
                console.log("Прикрепляем обработчик к кнопке закрытия");
                document.getElementById('chatClose').addEventListener('click', closeChat);
            }
            
            if (document.getElementById('chatSend')) {
                console.log("Прикрепляем обработчик к кнопке отправки");
                document.getElementById('chatSend').addEventListener('click', handleSendMessage);
            }
            
            if (document.getElementById('chatInput')) {
                console.log("Прикрепляем обработчик к полю ввода");
                document.getElementById('chatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage();
                    }
                });
            }
            
            // Удаляем дублирующиеся обработчики для кнопки отправки и поля ввода, 
            // так как мы уже установили их выше

            // Вспомогательная функция для определения эмоций на основе текста
            function getEmotionsFromText(situation, thoughts) {
                console.log("Анализируем ситуацию и мысли:", situation, thoughts);
                
                // Простой анализ на основе ключевых слов
                const combinedText = (situation + ' ' + thoughts).toLowerCase();
                
                if (combinedText.includes('ссора') || combinedText.includes('конфликт') || 
                    combinedText.includes('спор') || combinedText.includes('обида')) {
                    return ['Гнев', 'Обида', 'Разочарование', 'Раздражение', 'Беспомощность'];
                } else if (combinedText.includes('экзамен') || combinedText.includes('тест') || 
                           combinedText.includes('выступление') || combinedText.includes('презентация')) {
                    return ['Тревога', 'Страх', 'Напряжение', 'Неуверенность', 'Волнение'];
                } else if (combinedText.includes('потеря') || combinedText.includes('расставание') || 
                           combinedText.includes('прощание') || combinedText.includes('утрата')) {
                    return ['Грусть', 'Печаль', 'Тоска', 'Одиночество', 'Опустошенность'];
                } else if (combinedText.includes('успех') || combinedText.includes('победа') || 
                           combinedText.includes('достижение') || combinedText.includes('награда')) {
                    return ['Радость', 'Гордость', 'Восторг', 'Удовлетворение', 'Воодушевление'];
                } else if (combinedText.includes('неожиданно') || combinedText.includes('сюрприз') || 
                           combinedText.includes('внезапно') || combinedText.includes('неожиданность')) {
                    return ['Удивление', 'Шок', 'Изумление', 'Растерянность', 'Любопытство'];
                } else {
                    // Если не удалось определить по ключевым словам, используем стандартный набор
                    return ['Радость', 'Грусть', 'Страх', 'Гнев', 'Удивление'];
                }
            }
            
            // Функция для создания слайдера интенсивности эмоции
            function createEmotionIntensitySlider() {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("❌ Элемент chatMessages не найден!");
                    return;
                }
                
                // Создаем контейнер для сообщения с современной структурой
                const message = document.createElement('div');
                message.className = 'message-wrapper bot-message';
                
                // Создаем HTML для слайдера с современной структурой
                let messageHTML = `
                    <div class="avatar bot-avatar">
                        <div class="avatar-inner">🤖</div>
                    </div>
                    <div class="message-container">
                        <div class="message-text">
                    <div class="emotion-intensity-container">
                        <div class="emotion-intensity-value" id="emotionIntensityValue">5</div>
                        <input type="range" min="1" max="10" value="5" class="emotion-intensity-slider" id="emotionIntensitySlider">
                        <div class="emotion-intensity-scale">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                            <span>6</span>
                            <span>7</span>
                            <span>8</span>
                            <span>9</span>
                            <span>10</span>
                        </div>
                        <button class="emotion-intensity-button">Подтвердить</button>
                            </div>
                        </div>
                        <div class="message-time">${getCurrentTime ? getCurrentTime() : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                
                // Устанавливаем HTML в элемент сообщения
                message.innerHTML = messageHTML;
                
                // Добавляем сообщение в чат
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                message.scrollIntoView({ behavior: 'smooth' });
                
                // Добавляем обработчик для слайдера
                const slider = message.querySelector('.emotion-intensity-slider');
                const valueDisplay = message.querySelector('.emotion-intensity-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    
                    // Меняем цвет числа в зависимости от значения
                    const value = parseInt(this.value);
                    if (value <= 3) {
                        valueDisplay.style.color = '#81c784'; // Зеленый для низкой интенсивности
                    } else if (value <= 7) {
                        valueDisplay.style.color = '#ffb74d'; // Оранжевый для средней интенсивности
                    } else {
                        valueDisplay.style.color = '#e57373'; // Красный для высокой интенсивности
                    }
                });
                
                // Добавляем обработчик для кнопки подтверждения
                const confirmButton = message.querySelector('.emotion-intensity-button');
                confirmButton.addEventListener('click', function() {
                    // Получаем выбранную интенсивность
                    const selectedIntensity = slider.value;
                    
                    // Добавляем выбранную интенсивность как ответ пользователя
                    if (typeof window.addUserMessage === 'function') {
                        window.addUserMessage(selectedIntensity);
                    } else if (typeof addUserMessage === 'function') {
                        addUserMessage(selectedIntensity);
                    } else {
                        // Создаем сообщение пользователя вручную, если функция не найдена
                        const userMsg = document.createElement('div');
                        userMsg.className = 'message-wrapper user-message';
                        userMsg.innerHTML = `
                            <div class="message-container">
                                <div class="message-text">${selectedIntensity}</div>
                                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            </div>
                        `;
                        chatMessages.appendChild(userMsg);
                        userMsg.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Сохраняем ответ в глобальном массиве userResponses
                    if (typeof window.userResponses === 'object') {
                        // Определяем тип вопроса на основе текущего индекса вопроса
                        const currentQuestion = window.chatQuestions && window.chatQuestions[window.currentQuestionIndex];
                        const questionId = currentQuestion ? (currentQuestion.id || 'intensity') : 'intensity';
                        
                        console.log(`🔄 Сохраняем интенсивность для вопроса типа ${questionId}`);
                        window.userResponses[questionId] = selectedIntensity;
                    } else {
                        console.error("❌ Ошибка: window.userResponses не является объектом!");
                    }
                    
                    // Увеличиваем индекс текущего вопроса
                    window.currentQuestionIndex++;
                    
                    // Показываем следующий вопрос через функцию из chat-init.js
                    setTimeout(() => {
                        if (typeof window.showNextQuestion === 'function') {
                            window.showNextQuestion();
                        } else if (typeof showNextQuestion === 'function') {
                            showNextQuestion();
                        } else {
                            console.error("❌ Функция showNextQuestion не найдена!");
                            // Пытаемся показать следующий вопрос альтернативным способом
                            if (window.chatQuestions && window.currentQuestionIndex < window.chatQuestions.length) {
                                const nextQuestion = window.chatQuestions[window.currentQuestionIndex];
                                const questionText = nextQuestion.question_text || nextQuestion.text;
                                if (typeof window.addBotMessage === 'function') {
                                    window.addBotMessage(questionText);
                                } else if (typeof addBotMessage === 'function') {
                                    addBotMessage(questionText);
                                }
                            }
                        }
                    }, 500);
                });
                
                return message;
            }
            
            // Добавляем функцию в глобальный объект window
            window.createEmotionIntensitySlider = createEmotionIntensitySlider;
            
            // Функция для анализа всех ответов пользователя и генерации финального сообщения
            async function analyzeFinalResponses() {
                try {
                    // Формируем запрос к API
                    const apiUrl = '/api/analyze-final';
                    
                    // Собираем все ответы пользователя
                    const requestData = {
                        responses: userResponses,
                        questions: chatQuestions
                    };
                    
                    // Отправляем запрос к серверу
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    // Проверяем успешность запроса
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    // Получаем результат
                    const result = await response.json();
                    
                    // Сохраняем результаты анализа в базу данных
                    await saveAnalysisResults();
                    
                    // Проверяем, есть ли анализ в ответе
                    if (result.success && result.analysis) {
                        return result.analysis;
                    }
                    
                    // Если API не вернул анализ, используем запасной вариант
                    throw new Error('No analysis returned from API');
                    
                } catch (error) {
                    console.error('Error analyzing final responses:', error);
                    
                    // Пытаемся сохранить результаты даже при ошибке анализа
                    try {
                        await saveAnalysisResults();
                    } catch (saveError) {
                        console.error('Error saving analysis results:', saveError);
                    }
                    
                    // В случае ошибки используем стандартное сообщение поддержки
                    return "Вы молодец! Вы проделали отличную работу по анализу своих эмоций и мыслей. Продолжайте практиковать эти навыки, и со временем вам будет легче справляться с подобными ситуациями. Помните, что осознание своих мыслей и эмоций — это первый шаг к позитивным изменениям. Верю, что дальше всё будет только лучше!";
                }
            }
            
            // Функция для сохранения результатов анализа в базу данных
            async function saveAnalysisResults() {
                try {
                    console.log('🔄 Сохранение результатов анализа в базу данных...');
                    console.log('Содержимое userResponses:', window.userResponses);
                    
                    if (!window.userResponses) {
                        console.error('❌ Объект userResponses не найден!');
                        throw new Error('Объект userResponses не найден');
                    }
                    
                    console.log('Количество ответов:', Object.keys(window.userResponses).length);
                    
                    if (Object.keys(window.userResponses).length < 8) {
                        console.error('❌ Недостаточно ответов для сохранения! Требуется минимум 8, получено ' + Object.keys(window.userResponses).length);
                        throw new Error('Недостаточно ответов для сохранения');
                    }
                    
                    // Проверяем, содержит ли объект ответы на все вопросы
                    const requiredQuestions = ['situation', 'thoughts', 'emotions', 'body', 
                                               'evidence_for', 'evidence_against', 'reframe', 'future_plan'];
                    let missingQuestions = [];
                    
                    for (let questionId of requiredQuestions) {
                        if (!window.userResponses[questionId]) {
                            missingQuestions.push(questionId);
                        }
                    }
                    
                    if (missingQuestions.length > 0) {
                        console.warn('⚠️ Отсутствуют ответы на некоторые вопросы:', missingQuestions);
                        console.log('Имеющиеся ответы:', Object.keys(window.userResponses));
                        if (missingQuestions.length > 3) {
                            throw new Error(`Недостаточно данных для сохранения. Отсутствуют ответы на вопросы: ${missingQuestions.join(', ')}`);
                        }
                    }
                    
                    // ИЗМЕНЕНО: Обрабатываем интенсивность как числа, с проверкой
                    let emotion_intensity_before = 5;  // значение по умолчанию
                    try {
                        const intensityValue = window.userResponses['intensity'];
                        if (intensityValue) {
                            emotion_intensity_before = parseInt(intensityValue, 10);
                            if (isNaN(emotion_intensity_before)) {
                                console.warn('⚠️ Значение интенсивности эмоции не является числом:', intensityValue);
                                emotion_intensity_before = 5;
                            }
                        }
                    } catch (error) {
                        console.error('❌ Ошибка при обработке интенсивности эмоции:', error);
                    }
                    
                    let emotion_intensity_after = 5;  // значение по умолчанию
                    try {
                        const changeValue = window.userResponses['emotionChange'];
                        if (changeValue) {
                            emotion_intensity_after = parseInt(changeValue, 10);
                            if (isNaN(emotion_intensity_after)) {
                                console.warn('⚠️ Значение изменения интенсивности эмоции не является числом:', changeValue);
                                emotion_intensity_after = 5;
                            }
                        }
                    } catch (error) {
                        console.error('❌ Ошибка при обработке изменения интенсивности эмоции:', error);
                    }
                    
                    // ИЗМЕНЕНО: Используем правильные имена ключей в userResponses для маппинга polyfill
                    const analysisData = {
                        situation: window.userResponses['situation'] || "Не указано",
                        thoughts: window.userResponses['thoughts'] || "Не указано",
                        emotion: window.userResponses['emotions'] || "Не указано",
                        emotion_intensity_before: window.userResponses['intensity'] || 5,
                        physical_reaction: window.userResponses['body'] || "Не указано",
                        evidence_for: window.userResponses['evidence_for'] || "Не указано",
                        evidence_against: window.userResponses['evidence_against'] || "Не указано",
                        rational_perspective: window.userResponses['reframe'] || "Не указано",
                        emotion_intensity_after: window.userResponses['emotion_change'] || 5,
                        future_coping: window.userResponses['future_plan'] || "Не указано"
                    };
                    
                    console.log('📦 Подготовленные данные для отправки:', analysisData);
                    
                    // Проверяем наличие авторизации
                    let authHeaders = {
                        'Content-Type': 'application/json'
                    };
                    
                    // Пробуем получить данные пользователя из разных источников
                    const userData = localStorage.getItem('telegramUser') || 
                                     localStorage.getItem('user') || 
                                     localStorage.getItem('userData');
                    
                    // Пробуем также получить токен напрямую
                    const authToken = localStorage.getItem('token') || 
                                      localStorage.getItem('auth_token') || 
                                      localStorage.getItem('authToken');
                    
                    console.log('Данные пользователя из localStorage:', userData);
                    console.log('Токен авторизации из localStorage:', authToken);
                    
                    // Если нашли токен, добавляем его в заголовки
                    if (authToken) {
                        console.log('✅ Найден токен авторизации:', authToken);
                        authHeaders['Authorization'] = `Bearer ${authToken}`;
                    }
                    
                    if (userData) {
                        console.log('✅ Найдены данные пользователя в localStorage:', userData);
                        try {
                            // Пробуем распарсить JSON, если это JSON строка
                            const parsedUserData = JSON.parse(userData);
                            console.log('✅ Данные пользователя успешно распарсены:', parsedUserData);
                            
                            // Добавляем все поля из userData в заголовки
                            if (typeof parsedUserData === 'object') {
                                // Если есть token внутри объекта, используем его для авторизации
                                if (parsedUserData.token) {
                                    authHeaders['Authorization'] = `Bearer ${parsedUserData.token}`;
                                }
                                
                                // Добавляем отдельные поля в заголовки
                                Object.keys(parsedUserData).forEach(key => {
                                    const value = parsedUserData[key];
                                    if (value) {
                                        authHeaders[`X-User-${key}`] = String(value);
                                    }
                                });
                                
                                // Также добавляем полную строку как отдельный заголовок
                                authHeaders['X-User-Data'] = userData;
                            }
                        } catch (e) {
                            console.warn('⚠️ Не удалось распарсить данные пользователя как JSON, используем как строку:', e);
                            // Если не JSON, используем как обычную строку
                            authHeaders['X-User-Data'] = userData;
                            if (!authHeaders['Authorization']) {
                                authHeaders['Authorization'] = `Bearer ${userData}`;
                            }
                        }
                    } else {
                        console.warn('⚠️ Данные пользователя в localStorage не найдены');
                    }
                    
                    // Добавляем soft_validation=1 к URL
                    const apiUrl = '/api/save-cbt-analysis?soft_validation=1';
                    console.log('📤 Отправка запроса к API:', apiUrl);
                    console.log('📤 Заголовки запроса:', authHeaders);
                    
                    // Отправляем запрос к API для сохранения данных
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: authHeaders,
                        body: JSON.stringify(analysisData),
                        credentials: 'include' // Добавляем cookies к запросу
                    });
                    
                    console.log('📥 Получен ответ от API, статус:', response.status);
                    
                    // Проверяем успешность запроса
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`❌ API вернул ошибку ${response.status}:`, errorText);
                        throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                    }
                    
                    // Получаем результат
                    const result = await response.json();
                    console.log('📋 Результат запроса:', result);
                    
                    if (result.success) {
                        console.log('✅ Результаты анализа успешно сохранены! ID:', result.analysis_id);
                        
                        // Отмечаем ежедневник как выполненный на сегодня
                        const today = new Date();
                        const todayString = today.toISOString().split('T')[0];
                        
                        // Сохраняем статус заполнения в localStorage
                        localStorage.setItem('lastJournalCompletedDate', todayString);
                        localStorage.setItem('journalCompletedToday', 'true');
                        
                        // Запускаем событие, чтобы отметить ежедневник выполненным
                        localStorage.setItem('journalCompleted', 'true');
                        
                        // Вызываем функцию отметки ежедневника (если на той же странице)
                        if (typeof markJournalCompleted === 'function') {
                            markJournalCompleted(todayString, 'сохранение анализа');
                        }
                    } else {
                        console.error('❌ Ошибка при сохранении результатов анализа:', result.error);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('❌ Ошибка при сохранении результатов анализа:', error);
                    throw error;
                }
            }
        });
        
        // Обнаружение мобильного устройства и добавление soft_validation
        document.addEventListener('DOMContentLoaded', function() {
            // Определяем, является ли устройство мобильным
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Устанавливаем атрибут для API запросов
            if (isMobile) {
                document.body.setAttribute('data-mobile', 'true');
                document.body.setAttribute('data-soft-validation', 'true');
                console.log("Mobile device detected, enabling soft validation mode");
                
                // Патчим fetch для добавления параметра soft_validation=1 ко всем запросам к нашему API
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    if (typeof url === 'string' && url.includes('/api/')) {
                        // Для API-запросов добавляем параметр soft_validation=1
                        const urlObj = new URL(url, window.location.origin);
                        urlObj.searchParams.set('soft_validation', '1');
                        url = urlObj.toString();
                    }
                    return originalFetch.call(this, url, options);
                };
            }
            
            // Обработчики событий для новых карточек функций
            const understandingCard = document.getElementById('understandingCard');
            const journalCard = document.getElementById('journalCard');
            const completedCard = document.getElementById('completedCard');
            
            if (understandingCard) {
                understandingCard.addEventListener('click', function() {
                    // Действие при нажатии на карточку "Понимание себя"
                    console.log('Переход к статьям о когнитивно-поведенческой терапии');
                    // В реальном приложении здесь будет переход на страницу со статьями
                });
            }
            
            // Обработчик для карточки "Умный ежедневник" теперь находится в другом месте,
            // где он открывает чат для анализа ситуации
            
            if (completedCard) {
                completedCard.addEventListener('click', function() {
                    // Действие при нажатии на пройденную карточку
                    console.log('Вы уже прошли этот материал');
                    // В реальном приложении здесь будет переход к уже пройденному материалу
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Функция для сброса состояния карточки и индикатора
            function resetCardStatus(card, indicator) {
                if (card) {
                    card.classList.remove('completed');
                    card.classList.add('active');
                }
                
                if (indicator) {
                    indicator.classList.remove('completed');
                    indicator.classList.add('active');
                }
                
                // Сбрасываем состояние индикатора умного ежедневника
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.remove('completed');
                }
                
                // Сбрасываем состояние карточки ежедневника
                const journalCard = document.getElementById('journalCard');
                if (journalCard) {
                    journalCard.classList.remove('completed');
                    journalCard.classList.add('active');
                }
                
                console.log('Сброшено состояние карточек и индикаторов');
            }
            
            // Проверка, прошел ли пользователь хотя бы один урок сегодня
            function checkTodayLessonProgress() {
                // Получаем карточку курсов и её индикатор
                const coursesCard = document.getElementById('coursesCard');
                const coursesIndicator = document.getElementById('coursesIndicator');
                
                // Сначала сбрасываем состояние (активируем, но не отмечаем как выполненные)
                resetCardStatus(coursesCard, coursesIndicator);
                
                // Текущая дата в формате YYYY-MM-DD
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // Проверяем локальное хранилище
                const lastCompletedDate = localStorage.getItem('lastLessonCompletedDate');
                const lastCompletedStatus = localStorage.getItem('lessonCompletedToday');
                
                // Если уже есть статус за сегодня, используем его
                if (lastCompletedDate === todayString && lastCompletedStatus === 'true') {
                    markCardCompleted(coursesCard, coursesIndicator, todayString, 'кэш localStorage');
                    return;
                }
                
                // Сначала получаем список курсов
                fetch('/api/courses?soft_validation=1')
                    .then(response => {
                        if (!response.ok) {
                            console.warn('Сервер вернул ошибку при запросе курсов:', response.status, response.statusText);
                            throw new Error('Ошибка при получении данных о курсах: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Проверяем прогресс пользователя
                            if (data.progress && data.progress.completed_lessons && data.progress.completed_lessons.length > 0) {
                                // Если есть завершенные уроки, проверяем когда последний раз был пройден урок
                                const lastAccessed = data.progress.last_accessed;
                                
                                if (lastAccessed && lastAccessed.startsWith(todayString)) {
                                    // Если последний доступ был сегодня, отмечаем как выполненную
                                    markCardCompleted(coursesCard, coursesIndicator, todayString, 'база данных - сегодняшний прогресс');
                                } else {
                                    console.log('Есть прогресс в базе, но не за сегодня:', lastAccessed);
                                }
                            } else {
                                console.log('Нет завершенных уроков в базе данных');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при проверке прогресса курсов:', error);
                        
                        // В случае ошибки попробуем использовать mood-data как запасной вариант
                        fetchWithAuth('/api/mood-data?soft_validation=1')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Ошибка при получении запасных данных: ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    const todayEntry = data.moodEntries.find(entry => 
                                        entry.date.startsWith(todayString)
                                    );
                                    
                                    if (todayEntry) {
                                        // Если есть запись за сегодня, считаем что пользователь активен
                                        markCardCompleted(coursesCard, coursesIndicator, todayString, 'данные настроения');
                                    }
                                }
                            })
                            .catch(err => {
                                console.error('Ошибка при резервной проверке:', err);
                                // Не делаем ничего, просто игнорируем эту ошибку
                            });
                    });
            }
            
            // Вспомогательная функция для отметки карточки как выполненной
            function markCardCompleted(card, indicator, dateString, source) {
                if (card) {
                    card.classList.remove('active');
                    card.classList.add('completed');
                }
                
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.classList.add('completed');
                }
                
                // Активируем индикатор "Умный ежедневник" если урок пройден
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.add('active');
                }
                
                // Сохраняем статус в localStorage
                localStorage.setItem('lastLessonCompletedDate', dateString);
                localStorage.setItem('lessonCompletedToday', 'true');
                
                console.log(`Карточка курсов и индикатор отмечены как выполненные (источник: ${source})`);
                
                // Добавляем синхронизацию с сервером
                saveUserStatus({
                    lesson_completed: true
                });
            }
            
            // Функция для отметки завершения ежедневника
            function markJournalCompleted(dateString, source) {
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                if (journalCard) {
                    journalCard.classList.remove('active');
                    journalCard.classList.add('completed');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.add('completed');
                }
                
                // Сохраняем прогресс
                userProgress.markJournalCompleted();
            }
            
            // Проверка, заполнил ли пользователь ежедневник сегодня
            function checkTodayJournalProgress() {
                // Получаем карточку ежедневника и её индикатор
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                // Текущая дата в формате YYYY-MM-DD
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // Проверяем локальное хранилище
                const lastCompletedDate = localStorage.getItem('lastJournalCompletedDate');
                const lastCompletedStatus = localStorage.getItem('journalCompletedToday');
                
                // Если уже есть статус за сегодня, используем его
                if (lastCompletedDate === todayString && lastCompletedStatus === 'true') {
                    markJournalCompleted(todayString, 'кэш localStorage');
                    return;
                }
                
                // Другие способы проверки статуса ежедневника могут быть добавлены здесь
                // Например, проверка через API
            }
            
            // Вызываем функцию проверки прогресса
            setTimeout(checkTodayLessonProgress, 500);
            // Вызываем функцию проверки ежедневника
            setTimeout(checkTodayJournalProgress, 600);
            
            // Обработчик события для отметки, что урок был пройден
            window.addEventListener('storage', function(e) {
                // Если это событие завершения урока
                if (e.key === 'lessonCompleted') {
                    // Текущая дата в формате YYYY-MM-DD
                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    
                    // Получаем карточку курсов и индикатор
                    const coursesCard = document.getElementById('coursesCard');
                    const coursesIndicator = document.getElementById('coursesIndicator');
                    
                    if (coursesCard) {
                        // Отмечаем карточку как выполненную
                        markCardCompleted(coursesCard, coursesIndicator, todayString, 'событие хранилища');
                    }
                }
                // Если это событие завершения ежедневника
                else if (e.key === 'journalCompleted') {
                    // Текущая дата в формате YYYY-MM-DD
                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    
                    // Отмечаем ежедневник как выполненный
                    markJournalCompleted(todayString, 'событие хранилища');
                }
            });
            
            // При открытии страницы курсов добавляем обработчик
            const coursesCard = document.getElementById('coursesCard');
            if (coursesCard) {
                coursesCard.addEventListener('click', function() {
                    // Устанавливаем флаг, что пользователь посетил страницу курсов
                    localStorage.setItem('visitedCoursesPage', 'true');
                });
            }
            
            // Удаляю дублирующийся обработчик клика для journalCard
            
            // Позиционирование индикаторов таймлайна относительно карточек
            function positionTimelineIndicators() {
                const cards = document.querySelectorAll('.feature-card');
                const indicators = document.querySelectorAll('.timeline-indicator');
                const timeline = document.querySelector('.features-timeline');
                
                // Проверяем, найдены ли все элементы
                if (!cards.length || !indicators.length || !timeline) {
                    console.error('Не найдены необходимые элементы для таймлайна');
                    return;
                }
                
                // Если количество индикаторов совпадает с количеством карточек
                if (cards.length === indicators.length) {
                    let firstIndicatorTop = 0;
                    let lastIndicatorTop = 0;
                    
                    cards.forEach((card, index) => {
                        const indicator = indicators[index];
                        const cardRect = card.getBoundingClientRect();
                        const containerRect = card.parentElement.getBoundingClientRect();
                        
                        // Вычисляем середину карточки относительно контейнера
                        const cardMiddle = cardRect.top + cardRect.height / 2 - containerRect.top;
                        
                        // Устанавливаем позицию индикатора
                        indicator.style.top = cardMiddle + 'px';
                        
                        // Запоминаем позицию первого и последнего индикатора
                        if (index === 0) {
                            firstIndicatorTop = cardMiddle;
                        }
                        if (index === cards.length - 1) {
                            lastIndicatorTop = cardMiddle;
                        }
                    });
                    
                    // Настраиваем вертикальную линию, чтобы она шла только от первого до последнего индикатора
                    timeline.style.top = firstIndicatorTop + 'px';
                    timeline.style.height = (lastIndicatorTop - firstIndicatorTop) + 'px';
                    
                    // Убедимся, что timeline виден
                    timeline.style.display = 'block';
                }
            }
            
            // Запускаем позиционирование после небольшой задержки для гарантии загрузки всех элементов
            setTimeout(function() {
                console.log('Выполняем позиционирование timeline элементов...');
                positionTimelineIndicators();
                
                // Проверяем результат позиционирования
                const timeline = document.querySelector('.features-timeline');
                if (timeline) {
                    console.log('Timeline стили:', {
                        display: timeline.style.display,
                        top: timeline.style.top,
                        height: timeline.style.height
                    });
                }
            }, 100);
            
            // И также при изменении размера окна
            window.addEventListener('resize', positionTimelineIndicators);
            
            // Запускаем инициализацию календаря настроения при необходимости
            setTimeout(initMoodCalendar, 1000);
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Находим элементы чата
            const chatOverlay = document.getElementById('chatOverlay');
            const chatClose = document.getElementById('chatClose');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            // Находим карточку ежедневника и добавляем обработчик клика
            const journalCard = document.getElementById('journalCard');
            if (journalCard) {
                journalCard.addEventListener('click', function(event) {
                    // Предотвращаем стандартное действие
                    event.preventDefault();
                    
                    // Ручное открытие чата без вызова функции openChat
                    if (chatOverlay) {
                        chatOverlay.classList.add('active');
                        
                        const chatContainer = document.getElementById('chatContainer');
                        if (chatContainer) {
                            // Применяем анимацию появления
                            chatContainer.style.opacity = '0';
                            chatContainer.style.transform = 'translateY(20px)';
                            
                            // Анимируем появление
                            setTimeout(() => {
                                chatContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                chatContainer.style.opacity = '1';
                                chatContainer.style.transform = 'translateY(0)';
                            }, 10);
                        }
                        
                        // Добавляем первое сообщение
                        if (chatMessages) {
                            // Очищаем предыдущие сообщения
                            chatMessages.innerHTML = '';
                            
                            // Создаем сообщение от бота
                            const message = document.createElement('div');
                            message.className = 'message message-bot';
                            message.textContent = "Опишите событие, вызвавшее сильные эмоции. Где, когда, с кем это произошло?";
                            chatMessages.appendChild(message);
                        }
                        
                        // Фокус на поле ввода
                        setTimeout(() => {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                userInput.focus();
                            }
                        }, 300);
                    }
                    
                    console.log('Открываем чат для анализа ситуации');
                });
                console.log('Добавлен обработчик клика для карточки "Умный ежедневник"');
            } else {
                console.error('Элемент journalCard не найден');
            }
            
            // Добавляем обработчик для кнопки закрытия чата
            const chatCloseButton = document.getElementById('chatCloseButton');
            if (chatCloseButton) {
                chatCloseButton.addEventListener('click', function() {
                    // Ручное закрытие чата
                    if (chatOverlay) {
                        // Применяем анимацию исчезновения к контейнеру
                        const chatContainer = document.getElementById('chatContainer');
                        if (chatContainer) {
                            // Анимируем исчезновение
                            chatContainer.style.opacity = '0';
                            chatContainer.style.transform = 'translateY(20px)';
                            
                            // Убираем класс active у оверлея после анимации
                            setTimeout(() => {
                                chatOverlay.classList.remove('active');
                                // Сброс стилей для следующего открытия
                                chatContainer.style.transition = '';
                            }, 300);
                        } else {
                            // Если контейнер не найден, просто скрываем оверлей
                            chatOverlay.classList.remove('active');
                        }
                    }
                    
                    console.log('Закрыт чат по клику на кнопку закрытия');
                });
            }
            
            // Обработчики для отправки сообщений
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            
            // Функция для добавления сообщения от пользователя
            function addUserMessage(text) {
                if (!chatMessages) return;
                
                const message = document.createElement('div');
                message.className = 'message message-user';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Функция для обработки отправки сообщения
            function handleSendMessage() {
                if (!userInput) return;
                
                const text = userInput.value.trim();
                if (text) {
                    // Добавляем сообщение пользователя
                    addUserMessage(text);
                    
                    // Сохраняем ответ пользователя
                    userResponses.push(text);
                    
                    // Очищаем поле ввода
                    userInput.value = '';
                    
                    // Увеличиваем индекс текущего вопроса
                    currentQuestionIndex++;
                    
                    // Если это второй вопрос (индекс 1), переходим к анализу эмоций
                    if (currentQuestionIndex === 2) {
                        // Добавляем задержку перед ответом бота
                        setTimeout(async () => {
                            // Добавляем сообщение с вопросом про эмоции
                            const botMessage = document.createElement('div');
                            botMessage.className = 'message message-bot';
                            botMessage.textContent = chatQuestions[currentQuestionIndex].text;
                            chatMessages.appendChild(botMessage);
                            
                            // Прокручиваем чат вниз
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            
                            // Анализируем ответы и показываем кнопки эмоций
                            setTimeout(async () => {
                                try {
                                    // Пытаемся получить список эмоций на основе предыдущих ответов
                                    const emotions = ['Радость', 'Грусть', 'Страх', 'Гнев', 'Тревога', 'Разочарование', 'Удивление', 'Стыд', 'Вина', 'Любопытство'];
                                    
                                    // Создаем блок с кнопками эмоций
                                    const emotionBlock = document.createElement('div');
                                    emotionBlock.className = 'message message-bot';
                
                let buttonsHTML = '<div class="emotion-buttons">';
                emotions.forEach(emotion => {
                    buttonsHTML += `<button class="emotion-button">${emotion}</button>`;
                });
                buttonsHTML += '</div>';
                
                                    emotionBlock.innerHTML = buttonsHTML;
                                    chatMessages.appendChild(emotionBlock);
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Добавляем обработчики для кнопок эмоций
                                    const emotionButtons = emotionBlock.querySelectorAll('.emotion-button');
                emotionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // Выделяем выбранную кнопку
                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // Получаем выбранную эмоцию
                        const selectedEmotion = this.textContent;
                        
                        // Добавляем выбранную эмоцию как ответ пользователя
                        if (typeof addUserMessage === 'function') {
                            addUserMessage(selectedEmotion);
                        } else if (typeof window.addUserMessage === 'function') {
                            window.addUserMessage(selectedEmotion);
                        } else {
                            // Создаем сообщение пользователя вручную, если функция не найдена
                            const userMsg = document.createElement('div');
                            userMsg.className = 'message-wrapper user-message';
                            userMsg.innerHTML = `
                                <div class="message-container">
                                    <div class="message-text">${selectedEmotion}</div>
                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            `;
                            chatMessages.appendChild(userMsg);
                            userMsg.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        // Сохраняем ответ в глобальном массиве userResponses
                        if (typeof window.userResponses === 'object') {
                            window.userResponses['emotions'] = selectedEmotion;
                        } else {
                            console.error("❌ Ошибка: window.userResponses не является объектом!");
                        }
                        
                        // Увеличиваем индекс текущего вопроса
                        window.currentQuestionIndex++;
                        
                            setTimeout(() => {
                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                            }, 500);
                    });
                });
                                } catch (error) {
                                    console.error('Ошибка при создании кнопок эмоций:', error);
                                    
                                    // В случае ошибки переходим к следующему вопросу
                                    currentQuestionIndex++;
                                    addBotMessage(chatQuestions[currentQuestionIndex].text);
                                }
                        }, 500);
                        }, 500);
                    } else {
                        // Для других вопросов просто переходим к следующему
                        // Добавляем задержку перед ответом бота 
                            setTimeout(() => {
                            // Проверяем, есть ли еще вопросы
                            if (currentQuestionIndex < chatQuestions.length) {
                                // Добавляем следующий вопрос
                                const message = document.createElement('div');
                                message.className = 'message message-bot';
                                message.textContent = chatQuestions[currentQuestionIndex].text;
                                chatMessages.appendChild(message);
                                
                                // Прокручиваем чат вниз
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                
                                // Если это вопрос об интенсивности эмоции
                                if (currentQuestionIndex === 8) {
                            setTimeout(() => {
                                        createEmotionIntensitySlider();
                                    }, 300);
                                }
                            } else {
                                // Если вопросы закончились, показываем финальное сообщение
                const message = document.createElement('div');
                message.className = 'message message-bot';
                                message.textContent = "Спасибо за ваши ответы! Этот анализ помог вам лучше понять свои эмоции и мысли. Вы можете закрыть окно чата или начать новый анализ.";
                chatMessages.appendChild(message);
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                    }, 500);
                    }
                }
            }
            
            // Добавляем обработчики для кнопки отправки и поля ввода
            if (sendButton) {
                sendButton.addEventListener('click', handleSendMessage);
                console.log('Добавлен обработчик клика для кнопки отправки сообщения');
            } else {
                console.error('Элемент sendButton не найден');
            }
            
            if (userInput) {
                userInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage();
                    }
                });
                console.log('Добавлен обработчик нажатия Enter в поле ввода');
                    } else {
                console.error('Элемент userInput не найден');
            }
        });
        
        // Глобальная функция для сброса данных прогресса из консоли
        window.resetLessonProgress = function() {
            // Удаляем данные о прохождении уроков
            localStorage.removeItem('lastLessonCompletedDate');
            localStorage.removeItem('lessonCompletedToday');
            localStorage.removeItem('lessonCompleted');
            
            // Удаляем данные о заполнении ежедневника
            localStorage.removeItem('lastJournalCompletedDate');
            localStorage.removeItem('journalCompletedToday');
            localStorage.removeItem('journalCompleted');
            
            // Сбрасываем состояние карточки и индикатора если страница загружена
            const coursesCard = document.getElementById('coursesCard');
            const coursesIndicator = document.getElementById('coursesIndicator');
            const journalIndicator = document.getElementById('journalIndicator');
            const journalCard = document.getElementById('journalCard');
            
            if (coursesCard) {
                coursesCard.classList.remove('completed');
                coursesCard.classList.add('active');
            }
            
            if (coursesIndicator) {
                coursesIndicator.classList.remove('completed');
                coursesIndicator.classList.add('active');
            }
            
            if (journalIndicator) {
                journalIndicator.classList.remove('active');
                journalIndicator.classList.remove('completed');
            }
            
            if (journalCard) {
                journalCard.classList.remove('completed');
                journalCard.classList.add('active');
            }
            
            console.log('Данные о прогрессе урока и ежедневника очищены. Состояние карточек и индикаторов сброшено.');
            return 'Прогресс урока и ежедневника успешно сброшен';
        };
        
        // Диагностический скрипт для проверки элементов чата
        setTimeout(function() {
            console.log("=== ДИАГНОСТИКА ЧАТА ===");
            console.log("journalCard существует:", !!document.getElementById('journalCard'));
            console.log("chatOverlay существует:", !!document.getElementById('chatOverlay'));
            console.log("chatContainer существует:", !!document.getElementById('chatContainer'));
            console.log("openChat существует:", typeof window.openChat === 'function');
            console.log("chatQuestions существует:", typeof window.chatQuestions !== 'undefined');
            console.log("chatMessages существует:", !!document.getElementById('chatMessages'));
            console.log("userInput существует:", !!document.getElementById('userInput'));
            console.log("chatClose существует:", !!document.getElementById('chatClose'));
            console.log("chatCloseButton существует:", !!document.getElementById('chatCloseButton'));
            console.log("sendButton существует:", !!document.getElementById('sendButton'));
            
            // Проверяем, можем ли мы получить доступ к функциям и переменным
            console.log("=== ПРОВЕРКА ОБЛАСТЕЙ ВИДИМОСТИ ===");
            try {
                const journalCard = document.getElementById('journalCard');
                if (journalCard) {
                    console.log("Добавляем тестовый обработчик на journalCard");
                    journalCard.addEventListener('click', function(event) {
                        console.log("Клик на journalCard обработан");
                        
                        // Пробуем выполнить действия openChat вручную
                        console.log("Пробуем открыть чат вручную");
                        try {
                            const chatOverlay = document.getElementById('chatOverlay');
                            if (chatOverlay) {
                                chatOverlay.classList.add('active');
                                console.log("chatOverlay.active установлен");
                            }
                            
                            const chatContainer = document.getElementById('chatContainer');
                            if (chatContainer) {
                                chatContainer.style.opacity = '1';
                                chatContainer.style.transform = 'translateY(0)';
                                chatContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                console.log("Анимация chatContainer установлена");
                            }
                        } catch (e) {
                            console.error("Ошибка при ручном открытии чата:", e);
                        }
                    });
                }
            } catch (e) {
                console.error("Ошибка при добавлении тестового обработчика:", e);
            }
            
            console.log("=== КОНЕЦ ДИАГНОСТИКИ ===");
        }, 1000);
        
        // Инициализация модуля анализа ситуаций
        window.CBTModule = (function() {
            // Функция для сохранения результатов анализа
            async function saveAnalysisResults() {
                try {
                    console.log('🔄 Сохранение результатов анализа в базу данных...');
                    console.log('Содержимое userResponses:', window.userResponses);
                    
                    if (!window.userResponses) {
                        console.error('❌ Объект userResponses не найден!');
                        throw new Error('Объект userResponses не найден');
                    }
                    
                    console.log('Количество ответов:', Object.keys(window.userResponses).length);
                    
                    if (Object.keys(window.userResponses).length < 8) {
                        console.error('❌ Недостаточно ответов для сохранения! Требуется минимум 8, получено ' + Object.keys(window.userResponses).length);
                        throw new Error('Недостаточно ответов для сохранения');
                    }
                    
                    // Проверяем, содержит ли объект ответы на все вопросы
                    const requiredQuestions = ['situation', 'thoughts', 'emotions', 'body', 
                                               'evidence_for', 'evidence_against', 'reframe', 'future_plan'];
                    let missingQuestions = [];
                    
                    for (let questionId of requiredQuestions) {
                        if (!window.userResponses[questionId]) {
                            missingQuestions.push(questionId);
                        }
                    }
                    
                    if (missingQuestions.length > 0) {
                        console.warn('⚠️ Отсутствуют ответы на некоторые вопросы:', missingQuestions);
                        console.log('Имеющиеся ответы:', Object.keys(window.userResponses));
                        if (missingQuestions.length > 3) {
                            throw new Error(`Недостаточно данных для сохранения. Отсутствуют ответы на вопросы: ${missingQuestions.join(', ')}`);
                        }
                    }
                    
                    // ИЗМЕНЕНО: Обрабатываем интенсивность как числа, с проверкой
                    let emotion_intensity_before = 5;  // значение по умолчанию
                    try {
                        const intensityValue = window.userResponses['intensity'];
                        if (intensityValue) {
                            emotion_intensity_before = parseInt(intensityValue, 10);
                            if (isNaN(emotion_intensity_before)) {
                                console.warn('⚠️ Значение интенсивности эмоции не является числом:', intensityValue);
                                emotion_intensity_before = 5;
                            }
                        }
                    } catch (error) {
                        console.error('❌ Ошибка при обработке интенсивности эмоции:', error);
                    }
                    
                    let emotion_intensity_after = 5;  // значение по умолчанию
                    try {
                        const changeValue = window.userResponses['emotionChange'];
                        if (changeValue) {
                            emotion_intensity_after = parseInt(changeValue, 10);
                            if (isNaN(emotion_intensity_after)) {
                                console.warn('⚠️ Значение изменения интенсивности эмоции не является числом:', changeValue);
                                emotion_intensity_after = 5;
                            }
                        }
                    } catch (error) {
                        console.error('❌ Ошибка при обработке изменения интенсивности эмоции:', error);
                    }
                    
                    // ИЗМЕНЕНО: Используем правильные имена ключей в userResponses для маппинга polyfill
                    const analysisData = {
                        situation: window.userResponses['situation'] || "Не указано",
                        thoughts: window.userResponses['thoughts'] || "Не указано",
                        emotion: window.userResponses['emotions'] || "Не указано",
                        emotion_intensity_before: window.userResponses['intensity'] || 5,
                        physical_reaction: window.userResponses['body'] || "Не указано",
                        evidence_for: window.userResponses['evidence_for'] || "Не указано",
                        evidence_against: window.userResponses['evidence_against'] || "Не указано",
                        rational_perspective: window.userResponses['reframe'] || "Не указано",
                        emotion_intensity_after: window.userResponses['emotion_change'] || 5,
                        future_coping: window.userResponses['future_plan'] || "Не указано"
                    };
                    
                    console.log('📦 Подготовленные данные для отправки:', analysisData);
                    
                    // Проверяем наличие авторизации
                    let authHeaders = {
                        'Content-Type': 'application/json'
                    };
                    
                    // Пробуем получить данные пользователя из разных источников
                    const userData = localStorage.getItem('telegramUser') || 
                                     localStorage.getItem('user') || 
                                     localStorage.getItem('userData');
                    
                    // Пробуем также получить токен напрямую
                    const authToken = localStorage.getItem('token') || 
                                      localStorage.getItem('auth_token') || 
                                      localStorage.getItem('authToken');
                    
                    console.log('Данные пользователя из localStorage:', userData);
                    console.log('Токен авторизации из localStorage:', authToken);
                    
                    // Если нашли токен, добавляем его в заголовки
                    if (authToken) {
                        console.log('✅ Найден токен авторизации:', authToken);
                        authHeaders['Authorization'] = `Bearer ${authToken}`;
                    }
                    
                    if (userData) {
                        console.log('✅ Найдены данные пользователя в localStorage:', userData);
                        try {
                            // Пробуем распарсить JSON, если это JSON строка
                            const parsedUserData = JSON.parse(userData);
                            console.log('✅ Данные пользователя успешно распарсены:', parsedUserData);
                            
                            // Добавляем все поля из userData в заголовки
                            if (typeof parsedUserData === 'object') {
                                // Если есть token внутри объекта, используем его для авторизации
                                if (parsedUserData.token) {
                                    authHeaders['Authorization'] = `Bearer ${parsedUserData.token}`;
                                }
                                
                                // Добавляем отдельные поля в заголовки
                                Object.keys(parsedUserData).forEach(key => {
                                    const value = parsedUserData[key];
                                    if (value) {
                                        authHeaders[`X-User-${key}`] = String(value);
                                    }
                                });
                                
                                // Также добавляем полную строку как отдельный заголовок
                                authHeaders['X-User-Data'] = userData;
                            }
                        } catch (e) {
                            console.warn('⚠️ Не удалось распарсить данные пользователя как JSON, используем как строку:', e);
                            // Если не JSON, используем как обычную строку
                            authHeaders['X-User-Data'] = userData;
                            if (!authHeaders['Authorization']) {
                                authHeaders['Authorization'] = `Bearer ${userData}`;
                            }
                        }
                    } else {
                        console.warn('⚠️ Данные пользователя в localStorage не найдены');
                    }
                    
                    // Добавляем soft_validation=1 к URL
                    const apiUrl = '/api/save-cbt-analysis?soft_validation=1';
                    console.log('📤 Отправка запроса к API:', apiUrl);
                    console.log('📤 Заголовки запроса:', authHeaders);
                    
                    // Отправляем запрос к API для сохранения данных
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: authHeaders,
                        body: JSON.stringify(analysisData),
                        credentials: 'include' // Добавляем cookies к запросу
                    });
                    
                    console.log('📥 Получен ответ от API, статус:', response.status);
                    
                    // Проверяем успешность запроса
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`❌ API вернул ошибку ${response.status}:`, errorText);
                        throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                    }
                    
                    // Получаем результат
                    const result = await response.json();
                    console.log('📋 Результат запроса:', result);
                    
                    if (result.success) {
                        console.log('✅ Результаты анализа успешно сохранены! ID:', result.analysis_id);
                        
                        // Отмечаем ежедневник как выполненный на сегодня
                        const today = new Date();
                        const todayString = today.toISOString().split('T')[0];
                        
                        // Сохраняем статус заполнения в localStorage
                        localStorage.setItem('lastJournalCompletedDate', todayString);
                        localStorage.setItem('journalCompletedToday', 'true');
                        
                        // Запускаем событие, чтобы отметить ежедневник выполненным
                        localStorage.setItem('journalCompleted', 'true');
                        
                        // Вызываем функцию отметки ежедневника (если на той же странице)
                        if (typeof markJournalCompleted === 'function') {
                            markJournalCompleted(todayString, 'сохранение анализа');
                        }
                    } else {
                        console.error('❌ Ошибка при сохранении результатов анализа:', result.error);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('❌ Ошибка при сохранении результатов анализа:', error);
                    throw error;
                }
            }
            
            // Экспортируем функцию saveAnalysisResults
            return {
                saveAnalysisResults: saveAnalysisResults
            };
        })();
        
        // Делаем функцию сохранения доступной глобально напрямую
        window.saveAnalysisResults = window.CBTModule.saveAnalysisResults;
        
        // Проверяем, что функция действительно доступна глобально
        console.log('Проверка глобализации функции saveAnalysisResults:');
        console.log('typeof window.saveAnalysisResults:', typeof window.saveAnalysisResults);
        if (typeof window.saveAnalysisResults === 'function') {
            console.log('✅ Функция saveAnalysisResults успешно добавлена в глобальный объект window');
        } else {
            console.error('❌ ОШИБКА: Функция saveAnalysisResults не была добавлена в глобальный объект window');
            // Пробуем повторно добавить функцию
            window.saveAnalysisResults = function() {
                console.log('Вызвана запасная функция saveAnalysisResults');
                if (window.CBTModule && typeof window.CBTModule.saveAnalysisResults === 'function') {
                    return window.CBTModule.saveAnalysisResults();
                } else {
                    console.error('❌ КРИТИЧЕСКАЯ ОШИБКА: Не удалось найти функцию saveAnalysisResults');
                    throw new Error('Не удалось найти функцию saveAnalysisResults');
                }
            };
        }
        
        // Добавляем функцию отладки для ручного вызова сохранения из консоли
        window.debugSaveResults = function() {
            console.log('🔧 РУЧНОЙ ВЫЗОВ СОХРАНЕНИЯ РЕЗУЛЬТАТОВ');
            console.log('Содержимое window.userResponses:', window.userResponses);
            
            // Заполняем тестовыми данными, если не хватает ответов
            const requiredQuestions = ['situation', 'thoughts', 'emotions', 'intensity', 'body', 
                                      'evidence_for', 'evidence_against', 'reframe', 'emotionChange', 'futurePlan'];
            
            for (let questionId of requiredQuestions) {
                if (!window.userResponses[questionId]) {
                    console.log(`⚠️ Отсутствует ответ на вопрос ${questionId}, добавляем тестовые данные`);
                    window.userResponses[questionId] = `Тестовый ответ на вопрос ${questionId}`;
                }
            }
            
            console.log('Количество ответов после заполнения:', Object.keys(window.userResponses).length);
            
            if (typeof window.saveAnalysisResults === 'function') {
                return window.saveAnalysisResults()
                    .then(result => {
                        console.log('✅ Результаты успешно сохранены (debug):', result);
                        return result;
                    })
                    .catch(error => {
                        console.error('❌ Ошибка при сохранении результатов (debug):', error);
                        throw error;
                    });
            } else {
                console.error('❌ Функция saveAnalysisResults не найдена в глобальном объекте window!');
                throw new Error('Функция saveAnalysisResults не найдена');
            }
        };
        
        // Проверяем, что функция действительно доступна глобально
        console.log('Проверка глобализации функции saveAnalysisResults:');
        console.log('typeof window.saveAnalysisResults:', typeof window.saveAnalysisResults);
        if (typeof window.saveAnalysisResults === 'function') {
            console.log('✅ Функция saveAnalysisResults успешно добавлена в глобальный объект window');
        } else {
            console.error('❌ ОШИБКА: Функция saveAnalysisResults не была добавлена в глобальный объект window');
            // Пробуем повторно добавить функцию
            window.saveAnalysisResults = function() {
                console.log('Вызвана запасная функция saveAnalysisResults');
                if (window.CBTModule && typeof window.CBTModule.saveAnalysisResults === 'function') {
                    return window.CBTModule.saveAnalysisResults();
                } else {
                    console.error('❌ КРИТИЧЕСКАЯ ОШИБКА: Не удалось найти функцию saveAnalysisResults');
                    throw new Error('Не удалось найти функцию saveAnalysisResults');
                }
            };
        }
        
        // Обнаружение мобильного устройства и добавление soft_validation
    </script>
    
    <script>
        // Функция для проверки, является ли это первой сессией пользователя
        function isFirstSession() {
            try {
                return localStorage.getItem('hasCompletedOnboarding') !== 'true';
            } catch (error) {
                console.error("Ошибка при проверке первой сессии:", error);
                return false;
            }
        }
        
        // Функция для отметки, что онбординг пройден
        function markOnboardingCompleted() {
            try {
                localStorage.setItem('hasCompletedOnboarding', 'true');
            } catch (error) {
                console.error("Ошибка при сохранении состояния онбординга:", error);
            }
        }
        
        // Функция для запуска онбординга
        function startOnboarding() {
            // Шаг 1: Начальное сообщение
            showOnboardingStep(1);
        }
        
        // Функция для отображения конкретного шага онбординга
        function showOnboardingStep(step) {
            const speechBubble = document.querySelector('.speech-bubble');
            if (!speechBubble) return;
            
            // Содержимое для каждого шага
            const steps = {
                1: {
                    content: `
                        Привет! Представь, что твой разум — это компьютер, где иногда запускаются вредные программы. Я помогу тебе найти и обновить их.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext1">Далее</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(2)
                },
                2: {
                    content: `
                        Каждая сильная эмоция — это сигнал. Но не всегда правдивый. Когда ты расстроен, твой мозг часто выдает автоматические мысли, которые только усиливают негативные чувства.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext2">Далее</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(3)
                },
                3: {
                    content: `
                        Вот в чем секрет: изменив одну мысль, ты меняешь всю цепочку реакций! Я помогу тебе увидеть эти мысли и найти им более сбалансированную альтернативу — и твоя жизнь начнет меняться прямо на глазах.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext3">Далее</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(4)
                },
                4: {
                    content: `
                        Я тебе рекомендую сначала пройти первый урок который займет 5 минут, ты сможешь лучше понимать как это работает и внедрить в свою жизнь
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingStart">Начать</button>
                            <button class="action-button skip-button" id="onboardingSkip">Пропустить</button>
                        </div>
                    `,
                    buttonHandler: (isStart) => {
                        markOnboardingCompleted();
                        if (isStart) {
                            window.location.href = '/courses';
                        } else {
                            // Если пользователь пропускает, сразу показываем базовое приветствие
                            const speechBubble = document.querySelector('.speech-bubble');
                            if (speechBubble) {
                                speechBubble.innerHTML = `
                                    Привет! Хочешь разобрать какие-либо ситуации?
                                    <div class="speech-bubble-actions">
                                        <button class="action-button analyze-button" id="analyzeButton">Да, давай</button>
                                        <button class="action-button skip-button" id="skipButton">Не нужно</button>
                                    </div>
                                `;
                                
                                // Добавляем обработчики для кнопок
                                const analyzeButton = document.getElementById('analyzeButton');
                                const skipButton = document.getElementById('skipButton');
                                
                                if (analyzeButton) {
                                    analyzeButton.addEventListener('click', openChat);
                                }
                                
                                if (skipButton) {
                                    skipButton.addEventListener('click', function() {
                                        speechBubble.innerHTML = `
                                            Хорошо, в любой момент ты можешь вернуться, и я помогу тебе разобраться с любой ситуацией
                                            <div class="speech-bubble-actions">
                                                <button class="action-button analyze-button" id="analyzeAfterSkip">Разобрать ситуации</button>
                                            </div>
                                        `;
                                        
                                        const analyzeAfterSkip = document.getElementById('analyzeAfterSkip');
                                        if (analyzeAfterSkip) {
                                            analyzeAfterSkip.addEventListener('click', openChat);
                                        }
                                    });
                                }
                            }
                        }
                    },
                    animateCoursesCard: true
                }
            };
            
            // Применяем контент для текущего шага
            const currentStep = steps[step];
            if (!currentStep) return;
            
            speechBubble.innerHTML = currentStep.content;
            
            // Добавляем обработчики для кнопок
            const buttonId = `onboardingNext${step}`;
            const button = document.getElementById(buttonId) || document.getElementById('onboardingStart');
            if (button) {
                button.addEventListener('click', function() {
                    if (step === 4) {
                        currentStep.buttonHandler(true);
                    } else {
                        currentStep.buttonHandler();
                    }
                });
            }
            
            // Добавляем обработчик для кнопки "Пропустить" на шаге 4
            if (step === 4) {
                const skipButton = document.getElementById('onboardingSkip');
                if (skipButton) {
                    skipButton.addEventListener('click', function() {
                        currentStep.buttonHandler(false);
                    });
                }
                
                // Запускаем анимацию для карточки курсов
                setTimeout(() => {
                    animateCoursesCard();
                }, 5000); // 5 секунд
            }
        }
        
        // Функция для анимации карточки курсов
        function animateCoursesCard() {
            const coursesCard = document.getElementById('coursesCard');
            if (!coursesCard) return;
            
            // Добавляем класс для анимации
            coursesCard.classList.add('attention-animation');
            
            // Удаляем класс анимации через 2 секунды
            setTimeout(() => {
                coursesCard.classList.remove('attention-animation');
            }, 2000);
        }
        
        // При загрузке документа проверяем, нужно ли запускать онбординг
        document.addEventListener('DOMContentLoaded', function() {
            if (isFirstSession()) {
                // Запускаем онбординг для новых пользователей
                startOnboarding();
            } else {
                // Проверяем статусы из localStorage
                const lessonCompleted = localStorage.getItem('lessonCompletedToday') === 'true';
                const journalCompleted = localStorage.getItem('journalCompletedToday') === 'true';
                
                // Показываем сообщение в зависимости от статуса
                const speechBubble = document.querySelector('.speech-bubble');
                if (speechBubble) {
                    let message = '';
                    let buttons = '';
                    
                    if (!lessonCompleted && !journalCompleted) {
                        message = 'Привет! Начни свой день с короткого урока или анализа ситуации.';
                    } else if (lessonCompleted && !journalCompleted) {
                        message = 'Отлично, урок пройден, давайте теперь создадим новую запись в твоем ежедневнике.';
                    } else if (!lessonCompleted && journalCompleted) {
                        message = 'Здорово, что ты проанализировал ситуацию! Предлагаю также пройти сегодняшний урок.';
                    } else {
                        message = 'Супер! На сегодня ты молодец - урок пройден и ситуация проанализирована!';
                    }
                    
                    speechBubble.innerHTML = `${message}`;
                }
                
                // Обновляем состояние карточек
                if (lessonCompleted) {
                    markCardCompleted(
                        document.getElementById('coursesCard'),
                        document.getElementById('coursesIndicator'),
                        new Date().toISOString().split('T')[0],
                        'проверка при загрузке'
                    );
                }
                
                if (journalCompleted) {
                    markJournalCompleted(
                        new Date().toISOString().split('T')[0],
                        'проверка при загрузке'
                    );
                }
            }
        });
    </script>
    <!-- Добавляем скрипт для работы с прогрессом пользователя -->
    <script src="{{ url_for('static', filename='js/user-progress.js') }}"></script>
    <script>
        // Инициализируем прогресс пользователя
        let userProgress;
        document.addEventListener('DOMContentLoaded', function() {
            userProgress = new UserProgress();
            
            // Обновляем функцию markOnboardingCompleted
            function markOnboardingCompleted() {
                userProgress.markOnboardingCompleted();
            }
            
            // Обновляем функцию markCardCompleted
            function markCardCompleted(card, indicator, dateString, source) {
                if (card) {
                    card.classList.remove('active');
                    card.classList.add('completed');
                }
                
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.classList.add('completed');
                }
                
                // Активируем индикатор "Умный ежедневник" если урок пройден
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.add('active');
                }
                
                // Сохраняем прогресс
                userProgress.markLessonCompleted();
            }
            
            // Обновляем функцию markJournalCompleted
            function markJournalCompleted(dateString, source) {
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                if (journalCard) {
                    journalCard.classList.remove('active');
                    journalCard.classList.add('completed');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.add('completed');
                }
                
                // Сохраняем прогресс
                userProgress.markJournalCompleted();
            }
            
            // Обновляем функцию resetLessonProgress
            window.resetLessonProgress = function() {
                userProgress.resetProgress();
                
                // Сбрасываем состояние карточек и индикаторов
                const coursesCard = document.getElementById('coursesCard');
                const coursesIndicator = document.getElementById('coursesIndicator');
                const journalIndicator = document.getElementById('journalIndicator');
                const journalCard = document.getElementById('journalCard');
                
                if (coursesCard) {
                    coursesCard.classList.remove('completed');
                    coursesCard.classList.add('active');
                }
                
                if (coursesIndicator) {
                    coursesIndicator.classList.remove('completed');
                    coursesIndicator.classList.add('active');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.remove('completed');
                }
                
                if (journalCard) {
                    journalCard.classList.remove('completed');
                    journalCard.classList.add('active');
                }
                
                console.log('Данные о прогрессе урока и ежедневника очищены. Состояние карточек и индикаторов сброшено.');
                return 'Прогресс урока и ежедневника успешно сброшен';
            };
            
            // Проверяем статусы при загрузке страницы
            function checkTodayProgress() {
                const lessonCompleted = userProgress.isCompletedToday('lesson');
                const journalCompleted = userProgress.isCompletedToday('journal');
                
                // Показываем сообщение в зависимости от статуса
                const speechBubble = document.querySelector('.speech-bubble');
                if (speechBubble) {
                    let message = '';
                    let buttons = '';
                    
                    if (!lessonCompleted && !journalCompleted) {
                        message = 'Привет! Начни свой день с короткого урока или анализа ситуации.';
                        buttons = `
                            <button class="action-button analyze-button" id="startLessonBtn">Начать урок</button>
                            <button class="action-button analyze-button" id="startJournalBtn">Сделать заметку</button>
                        `;
                    } else if (lessonCompleted && !journalCompleted) {
                        message = 'Отлично, урок пройден, давайте теперь создадим новую запись в твоем ежедневнике.';
                        buttons = `
                            <button class="action-button analyze-button" id="startJournalBtn">Сделать заметку</button>
                        `;
                    } else if (!lessonCompleted && journalCompleted) {
                        message = 'Здорово, что ты проанализировал ситуацию! Предлагаю также пройти сегодняшний урок.';
                        buttons = `
                            <button class="action-button analyze-button" id="startLessonBtn">Начать урок</button>
                        `;
                    } else {
                        message = 'Супер! На сегодня ты молодец - урок пройден и ситуация проанализирована!';
                    }
                    
                    speechBubble.innerHTML = `
                        ${message}
                        <div class="speech-bubble-actions">
                            ${buttons}
                        </div>
                    `;
                    
                    // Добавляем обработчики после обновления DOM
                    const startLessonBtn = document.getElementById('startLessonBtn');
                    const startJournalBtn = document.getElementById('startJournalBtn');
                    
                    if (startLessonBtn) {
                        startLessonBtn.addEventListener('click', function() {
                            window.location.href = '/courses';
                        });
                    }
                    
                    if (startJournalBtn) {
                        startJournalBtn.addEventListener('click', function() {
                            openChat();
                        });
                    }
                }
                
                // Обновляем состояние карточек
                if (lessonCompleted) {
                    markCardCompleted(
                        document.getElementById('coursesCard'),
                        document.getElementById('coursesIndicator'),
                        new Date().toISOString().split('T')[0],
                        'проверка при загрузке'
                    );
                }
                
                if (journalCompleted) {
                    markJournalCompleted(
                        new Date().toISOString().split('T')[0],
                        'проверка при загрузке'
                    );
                }
            }
            
            // Запускаем проверку прогресса
            checkTodayProgress();
        });
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="parallax-image" id="parallaxImage"></div>

    <!-- Плашка приветствия от облачка -->
    <div class="speech-bubble"></div>

    <div class="container">
        <!-- Новый блок с карточками функций -->
        <div class="features-container">
            <div class="features-timeline"></div>
            <!-- Индикаторы вынесены наружу и не являются вложенными в карточки -->
            <div class="timeline-indicator" id="coursesIndicator"></div>
            <div class="timeline-indicator" id="journalIndicator"></div>
            
            <div class="feature-card" id="coursesCard" onclick="window.location.href='/courses'">
                <div class="feature-content">
                    <h2 class="feature-title">Курсы по КПТ</h2>
                    <p class="feature-subtitle">Изучите основы когнитивно-поведенческой терапии</p>
                </div>
                <div class="feature-image">
                    <img src="static/img/Cutesy_3D_asset_7dQCU2bWU1k15pJ3wEKvzsb6_A_man_stands_with_his_back (1).png" alt="Курсы">
                </div>
            </div>
            
            <div class="feature-card" id="journalCard" style="position: relative; overflow: hidden;">
                <div class="feature-content">
                    <h2 class="feature-title">Умный ежедневник</h2>
                    <p class="feature-subtitle">Создайте новую запись</p>
                </div>
                <div class="feature-image">
                    <img src="static/img/Cutesy_3D_asset_tBxQ6vN6ZJ6Qdwn3JShaGXTP_simple_still_life_composition (1).png" alt="Ежедневник">
                </div>
            </div>
        </div>
        
        <!-- Блок для отображения календаря настроения -->
        <div class="streak-container">
            <div class="streak-title">Ваш календарь внутреннего состояния</div>
            <div class="mood-calendar" id="moodCalendar">
                <!-- Календарь будет заполнен динамически через JavaScript -->
            </div>
        </div>
        
        <!-- Основной контент -->
        <div id="content" style="display: none;">
        </div>
    </div>
    
    <!-- Оверлей чата -->
    <div class="chat-overlay" id="chatOverlay">
        <!-- Контейнер чата -->
        <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <button class="chat-close-button" id="chatCloseButton">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2 class="chat-title">Умный ежедневник</h2>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Сообщения будут добавляться динамически -->
        </div>
        <div class="chat-input-container">
            <input type="text" id="userInput" class="chat-input" placeholder="Введите сообщение...">
            <button id="sendButton" class="chat-send-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>
    </div>
</body>
</html> 