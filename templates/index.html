<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç</title>
   
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞ -->
    <script src="{{ url_for('static', filename='js/chat-init.js') }}"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ -->
    <script src="{{ url_for('static', filename='js/fix-first-message.js') }}"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ -->
    <script src="{{ url_for('static', filename='js/fix-follow-up-style.js') }}"></script>
    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ chat-init.js -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ chat-init.js –∑–∞–≥—Ä—É–∂–µ–Ω
            if (typeof window.handleSendMessage === 'function') {
                console.log("‚úÖ –§–∞–π–ª chat-init.js —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–∏");
                
                // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
                const chatSend = document.getElementById('chatSend');
                const chatInput = document.getElementById('chatInput');
                
                if (chatSend) {
                    chatSend.onclick = window.handleSendMessage;
                    console.log("‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏");
                }
                
                if (chatInput) {
                    chatInput.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            window.handleSendMessage();
                        }
                    };
                    console.log("‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞");
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞, –Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                const chatButton = document.getElementById('journalCardChat');
                if (chatButton && typeof window.openChat === 'function') {
                    chatButton.onclick = window.openChat;
                    console.log("‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞");
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞, –Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                const chatClose = document.getElementById('chatClose');
                if (chatClose && typeof window.closeChat === 'function') {
                    chatClose.onclick = window.closeChat;
                    console.log("‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞");
                }
                
                console.log("‚úÖ –§–∞–π–ª chat-init.js –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ");
            } else {
                console.log("‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª chat-init.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ß–∞—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.");
            }
        });
    </script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ Telegram Mini Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/telegram-app.js') }}" defer></script>
    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookie –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.cookie = "tgWebAppData=true; path=/; max-age=3600";
        
        // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            const stateSelectionContainer = document.querySelector('.state-selection-container');
            if (stateSelectionContainer) {
                stateSelectionContainer.style.display = 'none';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            const streakContainer = document.querySelector('.streak-container');
            if (streakContainer) {
                streakContainer.style.display = 'none';
            }
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp API
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp API
            const isTelegramWebAppAvailable = window.Telegram && window.Telegram.WebApp;
            const tg = isTelegramWebAppAvailable ? window.Telegram.WebApp : null;
            
            // --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport ---
            if (tg) {
                const chatContainer = document.getElementById('chatContainer');
                
                const adjustViewportHeight = () => {
                    if (chatContainer && tg.viewportHeight) {
                         // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞–≤–Ω–æ–π –≤–∏–¥–∏–º–æ–π –≤—ã—Å–æ—Ç–µ viewport
                         // –í—ã—á–∏—Ç–∞–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É—á–µ—Å—Ç—å –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã
                         // –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å ` - 1`, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ
                        chatContainer.style.height = `${tg.viewportHeight}px`;
                        console.log(`Viewport changed. Set chat container height to: ${tg.viewportHeight}px`);
                    }
                };

                // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ viewport
                tg.onEvent('viewportChanged', adjustViewportHeight);
                // –í—ã–∑—ã–≤–∞–µ–º —Ç–∞–∫–∂–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ viewport —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω
                //adjustViewportHeight(); 
                
                // –†–∞—Å—à–∏—Ä—è–µ–º –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
               // tg.expand();
            }
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            let userName = "–¥—Ä—É–≥";
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userName = tg.initDataUnsafe.user.first_name || "–¥—Ä—É–≥";
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = userName;
            }
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram
            if (tg && tg.themeParams) {
                // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã –Ω–∞ —Å–≤–µ—Ç–ª—ã–µ
                document.documentElement.style.setProperty('--tg-theme-bg-color', '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-color', '#2481cc');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', '#ffffff');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –¥–ª—è body
                document.body.style.backgroundColor = '#ffffff';
                document.body.style.color = '#000000';
            }
            
            // Cloud-like floating animation for background image
            const parallaxImage = document.getElementById('parallaxImage');
            if (parallaxImage) {
                // Initial position variables
                let posX = 0;
                let posY = 0;
                let directionX = 1;  // 1 for right, -1 for left
                let directionY = 1;  // 1 for down, -1 for up
                
                // Animation speeds (smaller = slower)
                let speedX = 0.03;
                let speedY = 0.02;
                
                // Movement range
                const maxX = 15;  // max pixels to move horizontally
                const maxY = 12;   // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –±–æ–ª—å—à–µ–π –≤—ã—Å–æ—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
                
                // Time tracking for smooth speed changes
                let time = 0;
                const speedChangeInterval = 5000; // ms
                
                // Animation function
                function animateBackground() {
                    // Update time
                    time += 16; // Approximately 16ms per frame at 60fps
                    
                    // Occasionally vary the speed slightly to make movement more natural
                    if (time >= speedChangeInterval) {
                        // Slightly randomize speeds
                        speedX = 0.02 + Math.random() * 0.02; // Between 0.02 and 0.04
                        speedY = 0.01 + Math.random() * 0.02; // Between 0.01 and 0.03
                        time = 0;
                    }
                    
                    // Update positions with slight sinusoidal movement for more natural flow
                    posX += speedX * directionX;
                    posY += speedY * directionY * (0.9 + Math.sin(time/1000) * 0.1);
                    
                    // Change direction when reaching limits
                    if (Math.abs(posX) > maxX) {
                        directionX *= -1;
                    }
                    
                    if (Math.abs(posY) > maxY) {
                        directionY *= -1;
                    }
                    
                    // Apply the new position
                    parallaxImage.style.transform = `translateX(${-posX}px) translateY(${-posY}px)`;
                    
                    // Continue animation
                    requestAnimationFrame(animateBackground);
                }
                
                // Start animation
                animateBackground();
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            document.addEventListener('DOMContentLoaded', function() {
                const normalStateCard = document.getElementById('normalStateCard');
                const anxiousStateCard = document.getElementById('anxiousStateCard');
                const speechBubble = document.querySelector('.speech-bubble');
                const dayRatingContainer = document.getElementById('dayRatingContainer');
                
                if (normalStateCard && anxiousStateCard && speechBubble) {
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–í—Å—ë –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
                    normalStateCard.addEventListener('click', function() {
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–∞—Ç–∞
                        openChat();
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–ß—É–≤—Å—Ç–≤—É—é —Ç—Ä–µ–≤–æ–≥—É"
                    anxiousStateCard.addEventListener('click', function() {
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —á–∞—Ç–∞
                        openChat();
                    });
                }
            });
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            function generateMoodCalendar() {
                const moodCalendar = document.getElementById('moodCalendar');
                if (!moodCalendar) return;
                
                // –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                moodCalendar.innerHTML = '';
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                getMoodData().then(moodData => {
                    // –°–æ–∑–¥–∞–µ–º 4-–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±–∑–æ—Ä
                    create4WeekSnapshot(moodData, moodCalendar);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            async function getMoodData() {
                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º fetchWithAuth
                    const url = '/api/mood-data?soft_validation=1';
                    console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Å URL:', url);
                    
                    const response = await fetchWithAuth(url);
                    if (!response.ok) {
                        console.warn('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', response.status, response.statusText);
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏: ' + response.status);
                    }
                    
                    const data = await response.json();
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏:', data);
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫ –≤ –æ–±—ä–µ–∫—Ç—ã Date
                    if (data.firstVisitDate) {
                        data.firstVisitDate = new Date(data.firstVisitDate);
                    } else {
                        // –ï—Å–ª–∏ –ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É 28 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
                        const firstVisit = new Date();
                        firstVisit.setDate(firstVisit.getDate() - 28);
                        data.firstVisitDate = firstVisit;
                    }
                    
                    if (data.moodEntries && Array.isArray(data.moodEntries)) {
                        data.moodEntries = data.moodEntries.map(entry => ({
                            date: new Date(entry.date),
                            rating: entry.rating
                        }));
                    } else {
                        data.moodEntries = [];
                    }
                    
                    return data;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏:', error);
                    
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    const defaultData = {
                        firstVisitDate: new Date(new Date().setDate(new Date().getDate() - 28)),
                        moodEntries: [],
                        success: true // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–º –∫–æ–¥–æ–º
                    };
                    
                    return defaultData;
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è 4-–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ–±–∑–æ—Ä–∞
            function create4WeekSnapshot(moodData, container) {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
                const today = new Date();
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è –∏–ª–∏ –¥–∞—Ç—É 28 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                const firstVisitDate = moodData.firstVisitDate || new Date(today);
                firstVisitDate.setDate(firstVisitDate.getDate() - 27); // 28 –¥–Ω–µ–π –≤–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–æ–π –Ω–µ–¥–µ–ª–∏, –≤ –∫–æ—Ç–æ—Ä—É—é –ø–æ–ø–∞–¥–∞–µ—Ç firstVisitDate
                const startDay = new Date(firstVisitDate);
                const dayOfWeek = startDay.getDay();
                // getDay() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –¥–ª—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è, –ø–æ—ç—Ç–æ–º—É –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º
                const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startDay.setDate(startDay.getDate() - daysToSubtract);
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è 28 –¥–Ω–µ–π (4 –Ω–µ–¥–µ–ª–∏)
                const days = [];
                const currentDay = new Date(startDay);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è 28 –¥–Ω–µ–π
                for (let i = 0; i < 28; i++) {
                    // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    const moodEntry = moodData.moodEntries.find(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === currentDay.getFullYear() && 
                               entryDate.getMonth() === currentDay.getMonth() && 
                               entryDate.getDate() === currentDay.getDate();
                    });
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å –±—É–¥—É—â–∏–º –∏–ª–∏ –ø—Ä–æ—à–µ–¥—à–∏–º
                    const isFutureDay = currentDay > today;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–Ω–µ
                    days.push({
                        day: currentDay.getDate(),
                        date: new Date(currentDay),
                        isFutureDay: isFutureDay,
                        hasRating: !!moodEntry,
                        rating: moodEntry ? moodEntry.rating : null
                    });
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–Ω–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                days.forEach(dayData => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω—É–∂–Ω—ã–π –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–Ω—è
                    if (dayData.isFutureDay) {
                        // –ë—É–¥—É—â–∏–µ –¥–Ω–∏ —Å –±–µ–ª—ã–º —Ñ–æ–Ω–æ–º
                        dayElement.classList.add('future');
                    } else if (dayData.hasRating) {
                        // –î–Ω–∏ —Å –æ—Ü–µ–Ω–∫–æ–π
                        dayElement.classList.add('visited');
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ü–µ–Ω–∫–∏
                        if (dayData.rating <= 3) {
                            dayElement.classList.add('rating-low');
                        } else if (dayData.rating <= 7) {
                            dayElement.classList.add('rating-medium');
                        } else {
                            dayElement.classList.add('rating-high');
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                        const tooltip = document.createElement('span');
                        tooltip.className = 'calendar-tooltip';
                        
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
                        const formattedDate = new Intl.DateTimeFormat('ru-RU', { 
                            day: 'numeric', 
                            month: 'long' 
                        }).format(dayData.date);
                        
                        tooltip.textContent = `${formattedDate}: –û—Ü–µ–Ω–∫–∞ ${dayData.rating}`;
                        dayElement.appendChild(tooltip);
                    }
                    // –ü—Ä–æ—à–µ–¥—à–∏–µ –Ω–µ–æ—Ü–µ–Ω–µ–Ω–Ω—ã–µ –¥–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–µ—Ä—ã–º–∏ (–±–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å)
                    
                    container.appendChild(dayElement);
                });
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // generateMoodCalendar(); // –û—Ç–∫–ª—é—á–µ–Ω–æ, –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å–∫—Ä—ã—Ç
            
            // –£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—Ü–µ–Ω–∫–æ–π –¥–Ω—è
            
            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º
            const chatOverlay = document.getElementById('chatOverlay');
            const chatClose = document.getElementById('chatClose');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            // –ú–∞—Å—Å–∏–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–¥–∞–≤–∞–Ω–∏—è
            const chatQuestions = [
                {
                    id: "situation",
                    text: "–û–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ, –≤—ã–∑–≤–∞–≤—à–µ–µ —Å–∏–ª—å–Ω—ã–µ —ç–º–æ—Ü–∏–∏. –ì–¥–µ, –∫–æ–≥–¥–∞, —Å –∫–µ–º —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?"
                },
                {
                    id: "thoughts",
                    text: "–ö–∞–∫–∏–µ –º—ã—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –≤–∞–º –≤ –≥–æ–ª–æ–≤—É –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?"
                },
                {
                    id: "emotions",
                    text: "–ö–∞–∫–∏–µ —ç–º–æ—Ü–∏–∏ –≤—ã –∏—Å–ø—ã—Ç—ã–≤–∞–ª–∏? –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."
                },
                {
                    id: "intensity",
                    text: "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —ç—Ç–æ–π —ç–º–æ—Ü–∏–∏ –æ—Ç 1 –¥–æ 10."
                },
                {
                    id: "body",
                    text: "–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª–æ –≤–∞—à–µ —Ç–µ–ª–æ (—É—á–∞—â–µ–Ω–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ, –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –ø–æ—Ç–ª–∏–≤–æ—Å—Ç—å –∏ —Ç.–¥.)"
                },
                {
                    id: "evidenceFor",
                    text: "–ï—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Ç–æ–≥–æ, —á—Ç–æ –≤–∞—à–∞ –º—ã—Å–ª—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?"
                },
                {
                    id: "evidenceAgainst",
                    text: "–ï—Å—Ç—å –ª–∏ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–æ–≤–µ—Ä–≥–∞—é—Ç –≤–∞—à—É –º—ã—Å–ª—å?"
                },
                {
                    id: "reframe",
                    text: "–ö–∞–∫ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é –±–æ–ª–µ–µ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ?"
                },
                {
                    id: "emotionChange",
                    text: "–ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –≤–∞—à–∞ —ç–º–æ—Ü–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∫–∏ —Å–∏—Ç—É–∞—Ü–∏–∏? –û—Ü–µ–Ω–∏—Ç–µ –æ—Ç 1 –¥–æ 10."
                },
                {
                    id: "futurePlan",
                    text: "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É –≤ –±—É–¥—É—â–µ–º, —á—Ç–æ–±—ã —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –ø–æ–¥–æ–±–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π?"
                }
            ];
            
            // –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let userResponses = {};
            
            // –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è currentQuestionIndex –∑–¥–µ—Å—å
            let currentQuestionIndex = 0;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —ç–º–æ—Ü–∏–π
            async function analyzeUserResponses() {
                console.log('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ API');
                
                // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const situation = userResponses['situation'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
                const thoughts = userResponses['thoughts'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
                
                // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                const combinedText = (situation + ' ' + thoughts).toLowerCase();
                
                if (combinedText.includes('—Å—Å–æ—Ä–∞') || combinedText.includes('–∫–æ–Ω—Ñ–ª–∏–∫—Ç') || 
                    combinedText.includes('—Å–ø–æ—Ä') || combinedText.includes('–æ–±–∏–¥–∞')) {
                    return ['–ì–Ω–µ–≤', '–û–±–∏–¥–∞', '–†–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ', '–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ', '–ë–µ—Å–ø–æ–º–æ—â–Ω–æ—Å—Ç—å'];
                } else if (combinedText.includes('—ç–∫–∑–∞–º–µ–Ω') || combinedText.includes('—Ç–µ—Å—Ç') || 
                           combinedText.includes('–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ') || combinedText.includes('–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è')) {
                    return ['–¢—Ä–µ–≤–æ–≥–∞', '–°—Ç—Ä–∞—Ö', '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ', '–ù–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å', '–í–æ–ª–Ω–µ–Ω–∏–µ'];
                } else if (combinedText.includes('–ø–æ—Ç–µ—Ä—è') || combinedText.includes('—Ä–∞—Å—Å—Ç–∞–≤–∞–Ω–∏–µ') || 
                           combinedText.includes('–ø—Ä–æ—â–∞–Ω–∏–µ') || combinedText.includes('—É—Ç—Ä–∞—Ç–∞')) {
                    return ['–ì—Ä—É—Å—Ç—å', '–ü–µ—á–∞–ª—å', '–¢–æ—Å–∫–∞', '–û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ', '–û–ø—É—Å—Ç–æ—à–µ–Ω–Ω–æ—Å—Ç—å'];
                } else if (combinedText.includes('—É—Å–ø–µ—Ö') || combinedText.includes('–ø–æ–±–µ–¥–∞') || 
                           combinedText.includes('–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ') || combinedText.includes('–Ω–∞–≥—Ä–∞–¥–∞')) {
                    return ['–†–∞–¥–æ—Å—Ç—å', '–ì–æ—Ä–¥–æ—Å—Ç—å', '–í–æ—Å—Ç–æ—Ä–≥', '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ', '–í–æ–æ–¥—É—à–µ–≤–ª–µ–Ω–∏–µ'];
                } else if (combinedText.includes('–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ') || combinedText.includes('—Å—é—Ä–ø—Ä–∏–∑') || 
                           combinedText.includes('–≤–Ω–µ–∑–∞–ø–Ω–æ') || combinedText.includes('–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—å')) {
                    return ['–£–¥–∏–≤–ª–µ–Ω–∏–µ', '–®–æ–∫', '–ò–∑—É–º–ª–µ–Ω–∏–µ', '–†–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å', '–õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ'];
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä
                    return ['–†–∞–¥–æ—Å—Ç—å', '–ì—Ä—É—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–ì–Ω–µ–≤', '–£–¥–∏–≤–ª–µ–Ω–∏–µ'];
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —ç–º–æ—Ü–∏–π
            function createEmotionButtons(emotions) {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç chatMessages –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                const message = document.createElement('div');
                message.className = 'message-wrapper bot-message';
                
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π
                let messageHTML = `
                    <div class="avatar bot-avatar">
                        <div class="avatar-inner">ü§ñ</div>
                    </div>
                    <div class="message-container">
                        <div class="message-text">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö —ç–º–æ—Ü–∏–π:</p>
                            <div class="emotion-buttons">
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —ç–º–æ—Ü–∏–π
                emotions.forEach(emotion => {
                    messageHTML += `<button class="emotion-button">${emotion}</button>`;
                });
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º HTML-—Ç–µ–≥–∏
                messageHTML += `
                            </div>
                        </div>
                        <div class="message-time">${getCurrentTime ? getCurrentTime() : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML –≤ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                message.innerHTML = messageHTML;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                message.scrollIntoView({ behavior: 'smooth' });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π
                const emotionButtons = message.querySelectorAll('.emotion-button');
                emotionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é
                        const selectedEmotion = this.textContent;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é –∫–∞–∫ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (typeof addUserMessage === 'function') {
                            addUserMessage(selectedEmotion);
                        } else if (typeof window.addUserMessage === 'function') {
                            window.addUserMessage(selectedEmotion);
                        } else {
                            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                            const userMsg = document.createElement('div');
                            userMsg.className = 'message-wrapper user-message';
                            userMsg.innerHTML = `
                                <div class="message-container">
                                    <div class="message-text">${selectedEmotion}</div>
                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            `;
                            chatMessages.appendChild(userMsg);
                            userMsg.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ userResponses
                        if (typeof window.userResponses === 'object') {
                            window.userResponses['emotions'] = selectedEmotion;
                        } else {
                            console.error("‚ùå –û—à–∏–±–∫–∞: window.userResponses –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º!");
                        }
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                        window.currentQuestionIndex++;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ chat-init.js
                            setTimeout(() => {
                            if (typeof window.showNextQuestion === 'function') {
                                window.showNextQuestion();
                            } else if (typeof showNextQuestion === 'function') {
                                showNextQuestion();
                        } else {
                                console.error("‚ùå –§—É–Ω–∫—Ü–∏—è showNextQuestion –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                            }
                        }, 500);
                    });
                });
                
                return message;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window
            window.createEmotionButtons = createEmotionButtons;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
            function openChat() {
                console.log("üõë –í–´–ó–í–ê–ù–ê –õ–û–ö–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø openChat");
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è openChat
                if (typeof window.openChat === 'function') {
                    console.log("üõë –ù–∞–π–¥–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è openChat, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–µ");
                    window.openChat();
                    return;
                }
                
                console.log("üõë –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é openChat, —Ç.–∫. –≥–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                
                const chatOverlay = document.getElementById('chatOverlay');
                const chatMessages = document.getElementById('chatMessages');
                const chatInput = document.getElementById('chatInput');
                const chatSend = document.getElementById('chatSend');
                
                if (!chatOverlay || !chatMessages || !chatInput || !chatSend) {
                    console.error("–≠–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:", {
                        chatOverlay: !!chatOverlay,
                        chatMessages: !!chatMessages,
                        chatInput: !!chatInput,
                        chatSend: !!chatSend
                    });
                    return;
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–≤–µ—Ä–ª–µ–π
                chatOverlay.classList.add('active');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.style.display = 'block';
                    chatContainer.style.opacity = '1';
                }
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                chatMessages.innerHTML = '';
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã
                userResponses = {};
                
                // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                if (typeof window === 'object') {
                    window.userResponses = {};
                    console.log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window.userResponses —Å–±—Ä–æ—à–µ–Ω');
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞
                currentQuestionIndex = 0;
                
                // –¢–∞–∫–∂–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
                if (typeof window === 'object') {
                    window.currentQuestionIndex = 0;
                    console.log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å window.currentQuestionIndex —Å–±—Ä–æ—à–µ–Ω');
                }
                
                console.log("üõë –ò–ù–î–ï–ö–° –°–ë–†–û–®–ï–ù:", currentQuestionIndex);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                const firstQuestion = document.createElement('div');
                firstQuestion.className = 'message message-bot';
                firstQuestion.textContent = chatQuestions[0].text;
                chatMessages.appendChild(firstQuestion);
                
                console.log("üõë –î–û–ë–ê–í–õ–ï–ù –ü–ï–†–í–´–ô –í–û–ü–†–û–°:", chatQuestions[0].text);
                
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–º–µ–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                chatSend.onclick = function() {
                    console.log("üõë –ö–ù–û–ü–ö–ê –û–¢–ü–†–ê–í–ö–ò –ù–ê–ñ–ê–¢–ê");
                    if (typeof window.handleSendMessage === 'function') {
                        console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é window.handleSendMessage –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏");
                        window.handleSendMessage();
                    } else {
                        console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é handleSendMessage –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏");
                        handleSendMessage();
                    }
                };
                
                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ Enter
                chatInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        console.log("üõë –ù–ê–ñ–ê–¢–ê –ö–õ–ê–í–ò–®–ê ENTER");
                        if (typeof window.handleSendMessage === 'function') {
                            console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é window.handleSendMessage –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∞–≤–∏—à–∏ Enter");
                            window.handleSendMessage();
                        } else {
                            console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é handleSendMessage –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∞–≤–∏—à–∏ Enter");
                            handleSendMessage();
                        }
                    }
                };
            }
            
            // –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è Enter
            function handleEnterPress(e) {
                if (e.key === 'Enter') {
                    console.log("–ù–∞–∂–∞—Ç–∞ –∫–ª–∞–≤–∏—à–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞");
                    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
                    if (typeof window.handleSendMessage === 'function') {
                        console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é window.handleSendMessage –∏–∑ handleEnterPress");
                        window.handleSendMessage();
                    } else {
                        console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é handleSendMessage –∏–∑ handleEnterPress");
                        handleSendMessage();
                    }
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
            function closeChat() {
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    // –ê–Ω–∏–º–∏—Ä—É–µ–º –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
                    chatContainer.style.opacity = '0';
                    chatContainer.style.transform = 'translateY(20px)';
                    
                    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å active —É –æ–≤–µ—Ä–ª–µ—è –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                    setTimeout(() => {
                        chatOverlay.classList.remove('active');
                        // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
                        chatContainer.style.transition = '';
                    }, 300);
                } else {
                    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                chatOverlay.classList.remove('active');
                }
                
                console.log('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é closeChat');
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
            function addBotMessage(text) {
                console.log("–î–û–ë–ê–í–õ–Ø–Æ –°–û–û–ë–©–ï–ù–ò–ï –û–¢ –ë–û–¢–ê:", text);
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("–≠–ª–µ–º–µ–Ω—Ç chatMessages –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                
                const message = document.createElement('div');
                message.className = 'message message-bot';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–∏, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä
                if (text === chatQuestions[3].text || text === chatQuestions[8].text) {
                    setTimeout(() => {
                        createEmotionIntensitySlider();
                    }, 300);
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            function addUserMessage(text) {
                console.log("–î–û–ë–ê–í–õ–Ø–Æ –°–û–û–ë–©–ï–ù–ò–ï –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:", text);
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("–≠–ª–µ–º–µ–Ω—Ç chatMessages –Ω–µ –Ω–∞–π–¥–µ–Ω");
                    return;
                }
                
                const message = document.createElement('div');
                message.className = 'message message-user';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // –ï–î–ò–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            function handleSendMessage() {
                console.log("üõë –õ–û–ö–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø handleSendMessage –í–´–ó–í–ê–ù–ê");
                console.log("üõë window.handleSendMessage —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?", typeof window.handleSendMessage === 'function');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è handleSendMessage –∏–∑ chat-init.js, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–µ
                if (typeof window.handleSendMessage === 'function') {
                    console.log("üõë –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é window.handleSendMessage");
                    window.handleSendMessage();
                    return;
                }
                
                console.log("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è handleSendMessage, –∞ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –∏–∑ chat-init.js");
                console.log("üõë –û–ë–†–ê–ë–û–¢–ß–ò–ö –í–´–ó–í–ê–ù, —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å:", currentQuestionIndex);
                
                const chatInput = document.getElementById('chatInput');
                const chatMessages = document.getElementById('chatMessages');
                const userInput = document.getElementById('userInput');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫–æ–µ –Ω–∞–π–¥–µ–Ω–æ
                const inputField = chatInput || userInput;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (!inputField || !chatMessages) {
                    console.error("–≠–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:", {
                        inputField: !!inputField,
                        chatMessages: !!chatMessages
                    });
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
                const text = inputField.value.trim();
                
                // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π, –Ω–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ
                if (!text) {
                    console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ");
                    return;
                }
                
                console.log("üõë –ü–û–õ–£–ß–ï–ù –¢–ï–ö–°–¢:", text);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                addUserMessage(text);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –æ–±—ä–µ–∫—Ç userResponses
                const currentQuestion = chatQuestions[currentQuestionIndex];
                if (currentQuestion && currentQuestion.id) {
                    console.log(`üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ —Ç–∏–ø–∞ ${currentQuestion.id}`);
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window.userResponses –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    if (typeof window.userResponses === 'object') {
                        window.userResponses[currentQuestion.id] = text;
                        console.log(`‚úÖ –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ window.userResponses['${currentQuestion.id}']`);
                    } else {
                        console.error("‚ùå –û—à–∏–±–∫–∞: window.userResponses –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º!");
                    }
                    
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π userResponses –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    userResponses[currentQuestion.id] = text;
                } else {
                    console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞!");
                }
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                inputField.value = '';
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞
                currentQuestionIndex++;
                
                console.log("üõë –¢–ï–ö–£–©–ò–ô –ò–ù–î–ï–ö–°:", currentQuestionIndex);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(function() {
                    console.log("üõë –ü–û–î–ì–û–¢–û–í–ö–ê –ö –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Æ –í–û–ü–†–û–°–ê", currentQuestionIndex);
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –≤—Ç–æ—Ä–æ–π –≤–æ–ø—Ä–æ—Å (–∏–Ω–¥–µ–∫—Å 1), —Å –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
                    if (currentQuestionIndex === 1) {
                        console.log("üõë –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–¢–û–†–û–ô –í–û–ü–†–û–°");
                        addBotMessage(chatQuestions[currentQuestionIndex].text);
                    }
                    // –ï—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ—Ç–∏–π –≤–æ–ø—Ä–æ—Å (–∏–Ω–¥–µ–∫—Å 2), —Å –≤—ã–±–æ—Ä–æ–º —ç–º–æ—Ü–∏–π
                    else if (currentQuestionIndex === 2) {
                        console.log("üõë –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–†–ï–¢–ò–ô –í–û–ü–†–û–° –° –≠–ú–û–¶–ò–Ø–ú–ò");
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø—Ä–æ —ç–º–æ—Ü–∏–∏
                        addBotMessage(chatQuestions[currentQuestionIndex].text);
                        
                        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —ç–º–æ—Ü–∏–π
                        setTimeout(async () => {
                            try {
                                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —ç–º–æ—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                                const emotions = ['–†–∞–¥–æ—Å—Ç—å', '–ì—Ä—É—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–ì–Ω–µ–≤', '–¢—Ä–µ–≤–æ–≥–∞', '–†–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ', '–£–¥–∏–≤–ª–µ–Ω–∏–µ', '–°—Ç—ã–¥', '–í–∏–Ω–∞', '–õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ'];
                                
                                // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —ç–º–æ—Ü–∏–π
                                const emotionBlock = document.createElement('div');
                                emotionBlock.className = 'message message-bot';
                                
                                let buttonsHTML = '<div class="emotion-buttons">';
                                emotions.forEach(emotion => {
                                    buttonsHTML += `<button class="emotion-button">${emotion}</button>`;
                                });
                                buttonsHTML += '</div>';
                                
                                emotionBlock.innerHTML = buttonsHTML;
                                chatMessages.appendChild(emotionBlock);
                                
                                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π
                                const emotionButtons = emotionBlock.querySelectorAll('.emotion-button');
                                emotionButtons.forEach(button => {
                                    button.addEventListener('click', function() {
                                        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
                                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                                        this.classList.add('selected');
                                        
                                        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é
                                        const selectedEmotion = this.textContent;
                                        
                                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é –∫–∞–∫ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                        if (typeof addUserMessage === 'function') {
                                            addUserMessage(selectedEmotion);
                                        } else if (typeof window.addUserMessage === 'function') {
                                            window.addUserMessage(selectedEmotion);
                                        } else {
                                            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                                            const userMsg = document.createElement('div');
                                            userMsg.className = 'message-wrapper user-message';
                                            userMsg.innerHTML = `
                                                <div class="message-container">
                                                    <div class="message-text">${selectedEmotion}</div>
                                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                                </div>
                                            `;
                                            chatMessages.appendChild(userMsg);
                                            userMsg.scrollIntoView({ behavior: 'smooth' });
                                        }
                                        
                                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ userResponses
                                        if (typeof window.userResponses === 'object') {
                                            window.userResponses['emotions'] = selectedEmotion;
                                        } else {
                                            console.error("‚ùå –û—à–∏–±–∫–∞: window.userResponses –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º!");
                                        }
                                        
                                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                                        window.currentQuestionIndex++;
                                        
                                        setTimeout(() => {
                                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                                        }, 500);
                                    });
                                });
                            } catch (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π:', error);
                                
                                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                                currentQuestionIndex++;
                                addBotMessage(chatQuestions[currentQuestionIndex].text);
                            }
                        }, 500);
                    }
                    // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
                    else {
                        console.log("üõë –ü–û–ö–ê–ó–´–í–ê–ï–ú –û–ë–´–ß–ù–´–ô –í–û–ü–†–û–°:", currentQuestionIndex);
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã
                        console.log('üîç –ü–†–û–í–ï–†–ö–ê –£–°–õ–û–í–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –í INDEX.HTML:');
                        console.log(`   - currentQuestionIndex = ${currentQuestionIndex}`);
                        console.log(`   - chatQuestions.length = ${chatQuestions.length}`);
                        console.log(`   - –£—Å–ª–æ–≤–∏–µ: ${currentQuestionIndex < chatQuestions.length}`);
                        
                        if (currentQuestionIndex < chatQuestions.length) {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                            console.log(`üîÑ –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å #${currentQuestionIndex}: "${chatQuestions[currentQuestionIndex].text}"`);
                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                            
                            // –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –æ–± –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏
                            if (currentQuestionIndex === 8) {
                                setTimeout(() => {
                                    createEmotionIntensitySlider();
                                }, 300);
                            }
                        } else {
                            console.log("üéØ –£–°–õ–û–í–ò–ï –ó–ê–í–ï–†–®–ï–ù–ò–Ø –í–´–ü–û–õ–ù–ï–ù–û –í INDEX.HTML!");
                            // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            addBotMessage("–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã! –≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ–º–æ–≥ –≤–∞–º –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏ –∏ –º—ã—Å–ª–∏. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —á–∞—Ç–∞ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.");
                            
                            // –î–û–ë–ê–í–õ–Ø–ï–ú –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
                            console.log('üî¥ –í–´–ó–û–í –°–û–•–†–ê–ù–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ò–ó INDEX.HTML (–≤—Ç–æ—Ä–æ–π –±–ª–æ–∫)');
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ userResponses
                            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê userResponses (–≤—Ç–æ—Ä–æ–π –±–ª–æ–∫):');
                            console.log('typeof window.userResponses:', typeof window.userResponses);
                            console.log('–Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–∞—Å—Å–∏–≤–æ–º:', Array.isArray(window.userResponses));
                            console.log('–í—Å–µ –∫–ª—é—á–∏ –≤ userResponses:', Object.keys(window.userResponses));
                            console.log('–ó–Ω–∞—á–µ–Ω–∏—è –≤ userResponses:', window.userResponses);
                            
                            setTimeout(() => {
                                if (typeof window.saveAnalysisResults === 'function') {
                                    console.log('üî¥ –§–£–ù–ö–¶–ò–Ø saveAnalysisResults –ù–ê–ô–î–ï–ù–ê, –í–´–ó–´–í–ê–ï–ú...');
                                    window.saveAnalysisResults()
                                        .then(result => {
                                            console.log('üî¥ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–´:', result);
                                        })
                                        .catch(error => {
                                            console.error('üî¥ –û–®–ò–ë–ö–ê –ü–†–ò –°–û–•–†–ê–ù–ï–ù–ò–ò –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:', error);
                                        });
                                } else {
                                    console.error('üî¥ –§–£–ù–ö–¶–ò–Ø saveAnalysisResults –ù–ï –ù–ê–ô–î–ï–ù–ê!');
                                }
                            }, 1000);
                        }
                    }
                }, 500);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —á–∞—Ç–∞
            if (document.getElementById('chatClose')) {
                console.log("–ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è");
                document.getElementById('chatClose').addEventListener('click', closeChat);
            }
            
            if (document.getElementById('chatSend')) {
                console.log("–ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏");
                document.getElementById('chatSend').addEventListener('click', handleSendMessage);
            }
            
            if (document.getElementById('chatInput')) {
                console.log("–ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –ø–æ–ª—é –≤–≤–æ–¥–∞");
                document.getElementById('chatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage();
                    }
                });
            }
            
            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞, 
            // —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –∏—Ö –≤—ã—à–µ

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–º–æ—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞
            function getEmotionsFromText(situation, thoughts) {
                console.log("–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Ç—É–∞—Ü–∏—é –∏ –º—ã—Å–ª–∏:", situation, thoughts);
                
                // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                const combinedText = (situation + ' ' + thoughts).toLowerCase();
                
                if (combinedText.includes('—Å—Å–æ—Ä–∞') || combinedText.includes('–∫–æ–Ω—Ñ–ª–∏–∫—Ç') || 
                    combinedText.includes('—Å–ø–æ—Ä') || combinedText.includes('–æ–±–∏–¥–∞')) {
                    return ['–ì–Ω–µ–≤', '–û–±–∏–¥–∞', '–†–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ', '–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ', '–ë–µ—Å–ø–æ–º–æ—â–Ω–æ—Å—Ç—å'];
                } else if (combinedText.includes('—ç–∫–∑–∞–º–µ–Ω') || combinedText.includes('—Ç–µ—Å—Ç') || 
                           combinedText.includes('–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ') || combinedText.includes('–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è')) {
                    return ['–¢—Ä–µ–≤–æ–≥–∞', '–°—Ç—Ä–∞—Ö', '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ', '–ù–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å', '–í–æ–ª–Ω–µ–Ω–∏–µ'];
                } else if (combinedText.includes('–ø–æ—Ç–µ—Ä—è') || combinedText.includes('—Ä–∞—Å—Å—Ç–∞–≤–∞–Ω–∏–µ') || 
                           combinedText.includes('–ø—Ä–æ—â–∞–Ω–∏–µ') || combinedText.includes('—É—Ç—Ä–∞—Ç–∞')) {
                    return ['–ì—Ä—É—Å—Ç—å', '–ü–µ—á–∞–ª—å', '–¢–æ—Å–∫–∞', '–û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ', '–û–ø—É—Å—Ç–æ—à–µ–Ω–Ω–æ—Å—Ç—å'];
                } else if (combinedText.includes('—É—Å–ø–µ—Ö') || combinedText.includes('–ø–æ–±–µ–¥–∞') || 
                           combinedText.includes('–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ') || combinedText.includes('–Ω–∞–≥—Ä–∞–¥–∞')) {
                    return ['–†–∞–¥–æ—Å—Ç—å', '–ì–æ—Ä–¥–æ—Å—Ç—å', '–í–æ—Å—Ç–æ—Ä–≥', '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ', '–í–æ–æ–¥—É—à–µ–≤–ª–µ–Ω–∏–µ'];
                } else if (combinedText.includes('–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ') || combinedText.includes('—Å—é—Ä–ø—Ä–∏–∑') || 
                           combinedText.includes('–≤–Ω–µ–∑–∞–ø–Ω–æ') || combinedText.includes('–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—å')) {
                    return ['–£–¥–∏–≤–ª–µ–Ω–∏–µ', '–®–æ–∫', '–ò–∑—É–º–ª–µ–Ω–∏–µ', '–†–∞—Å—Ç–µ—Ä—è–Ω–Ω–æ—Å—Ç—å', '–õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ'];
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–∞–±–æ—Ä
                    return ['–†–∞–¥–æ—Å—Ç—å', '–ì—Ä—É—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–ì–Ω–µ–≤', '–£–¥–∏–≤–ª–µ–Ω–∏–µ'];
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏
            function createEmotionIntensitySlider() {
                const chatMessages = document.getElementById('chatMessages');
                if (!chatMessages) {
                    console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç chatMessages –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
                const message = document.createElement('div');
                message.className = 'message-wrapper bot-message';
                
                // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
                let messageHTML = `
                    <div class="avatar bot-avatar">
                        <div class="avatar-inner">ü§ñ</div>
                    </div>
                    <div class="message-container">
                        <div class="message-text">
                    <div class="emotion-intensity-container">
                        <div class="emotion-intensity-value" id="emotionIntensityValue">5</div>
                        <input type="range" min="1" max="10" value="5" class="emotion-intensity-slider" id="emotionIntensitySlider">
                        <div class="emotion-intensity-scale">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                            <span>6</span>
                            <span>7</span>
                            <span>8</span>
                            <span>9</span>
                            <span>10</span>
                        </div>
                        <button class="emotion-intensity-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            </div>
                        </div>
                        <div class="message-time">${getCurrentTime ? getCurrentTime() : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML –≤ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                message.innerHTML = messageHTML;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                message.scrollIntoView({ behavior: 'smooth' });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞
                const slider = message.querySelector('.emotion-intensity-slider');
                const valueDisplay = message.querySelector('.emotion-intensity-value');
                
                slider.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                    
                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —á–∏—Å–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
                    const value = parseInt(this.value);
                    if (value <= 3) {
                        valueDisplay.style.color = '#81c784'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –Ω–∏–∑–∫–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
                    } else if (value <= 7) {
                        valueDisplay.style.color = '#ffb74d'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
                    } else {
                        valueDisplay.style.color = '#e57373'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—ã—Å–æ–∫–æ–π –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
                    }
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                const confirmButton = message.querySelector('.emotion-intensity-button');
                confirmButton.addEventListener('click', function() {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
                    const selectedIntensity = slider.value;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∫ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (typeof window.addUserMessage === 'function') {
                        window.addUserMessage(selectedIntensity);
                    } else if (typeof addUserMessage === 'function') {
                        addUserMessage(selectedIntensity);
                    } else {
                        // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                        const userMsg = document.createElement('div');
                        userMsg.className = 'message-wrapper user-message';
                        userMsg.innerHTML = `
                            <div class="message-container">
                                <div class="message-text">${selectedIntensity}</div>
                                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            </div>
                        `;
                        chatMessages.appendChild(userMsg);
                        userMsg.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ userResponses
                    if (typeof window.userResponses === 'object') {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤–æ–ø—Ä–æ—Å–∞
                        const currentQuestion = window.chatQuestions && window.chatQuestions[window.currentQuestionIndex];
                        const questionId = currentQuestion ? (currentQuestion.id || 'intensity') : 'intensity';
                        
                        console.log(`üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ —Ç–∏–ø–∞ ${questionId}`);
                        window.userResponses[questionId] = selectedIntensity;
                    } else {
                        console.error("‚ùå –û—à–∏–±–∫–∞: window.userResponses –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º!");
                    }
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                    window.currentQuestionIndex++;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ chat-init.js
                    setTimeout(() => {
                        if (typeof window.showNextQuestion === 'function') {
                            window.showNextQuestion();
                        } else if (typeof showNextQuestion === 'function') {
                            showNextQuestion();
                        } else {
                            console.error("‚ùå –§—É–Ω–∫—Ü–∏—è showNextQuestion –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
                            if (window.chatQuestions && window.currentQuestionIndex < window.chatQuestions.length) {
                                const nextQuestion = window.chatQuestions[window.currentQuestionIndex];
                                const questionText = nextQuestion.question_text || nextQuestion.text;
                                if (typeof window.addBotMessage === 'function') {
                                    window.addBotMessage(questionText);
                                } else if (typeof addBotMessage === 'function') {
                                    addBotMessage(questionText);
                                }
                            }
                        }
                    }, 500);
                });
                
                return message;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window
            window.createEmotionIntensitySlider = createEmotionIntensitySlider;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            async function analyzeFinalResponses() {
                try {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
                    const apiUrl = '/api/analyze-final';
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const requestData = {
                        responses: userResponses,
                        questions: chatQuestions
                    };
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const result = await response.json();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                    await saveAnalysisResults();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–Ω–∞–ª–∏–∑ –≤ –æ—Ç–≤–µ—Ç–µ
                    if (result.success && result.analysis) {
                        return result.analysis;
                    }
                    
                    // –ï—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª –∞–Ω–∞–ª–∏–∑, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    throw new Error('No analysis returned from API');
                    
                } catch (error) {
                    console.error('Error analyzing final responses:', error);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–Ω–∞–ª–∏–∑–∞
                    try {
                        await saveAnalysisResults();
                    } catch (saveError) {
                        console.error('Error saving analysis results:', saveError);
                    }
                    
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                    return "–í—ã –º–æ–ª–æ–¥–µ—Ü! –í—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∏ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É –ø–æ –∞–Ω–∞–ª–∏–∑—É —Å–≤–æ–∏—Ö —ç–º–æ—Ü–∏–π –∏ –º—ã—Å–ª–µ–π. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —ç—Ç–∏ –Ω–∞–≤—ã–∫–∏, –∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –≤–∞–º –±—É–¥–µ—Ç –ª–µ–≥—á–µ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –ø–æ–¥–æ–±–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏. –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ —Å–≤–æ–∏—Ö –º—ã—Å–ª–µ–π –∏ —ç–º–æ—Ü–∏–π ‚Äî —ç—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º. –í–µ—Ä—é, —á—Ç–æ –¥–∞–ª—å—à–µ –≤—Å—ë –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –ª—É—á—à–µ!";
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            async function saveAnalysisResults() {
                try {
                    console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
                    console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ userResponses:', window.userResponses);
                    
                    if (!window.userResponses) {
                        console.error('‚ùå –û–±—ä–µ–∫—Ç userResponses –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                        throw new Error('–û–±—ä–µ–∫—Ç userResponses –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤:', Object.keys(window.userResponses).length);
                    
                    if (Object.keys(window.userResponses).length < 8) {
                        console.error('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è! –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 8, –ø–æ–ª—É—á–µ–Ω–æ ' + Object.keys(window.userResponses).length);
                        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                    const requiredQuestions = ['situation', 'thoughts', 'emotions', 'body', 
                                               'evidence_for', 'evidence_against', 'reframe', 'future_plan'];
                    let missingQuestions = [];
                    
                    for (let questionId of requiredQuestions) {
                        if (!window.userResponses[questionId]) {
                            missingQuestions.push(questionId);
                        }
                    }
                    
                    if (missingQuestions.length > 0) {
                        console.warn('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:', missingQuestions);
                        console.log('–ò–º–µ—é—â–∏–µ—Å—è –æ—Ç–≤–µ—Ç—ã:', Object.keys(window.userResponses));
                        if (missingQuestions.length > 3) {
                            throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã: ${missingQuestions.join(', ')}`);
                        }
                    }
                    
                    // –ò–ó–ú–ï–ù–ï–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∫ —á–∏—Å–ª–∞, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                    let emotion_intensity_before = 5;  // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    try {
                        const intensityValue = window.userResponses['intensity'];
                        if (intensityValue) {
                            emotion_intensity_before = parseInt(intensityValue, 10);
                            if (isNaN(emotion_intensity_before)) {
                                console.warn('‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º:', intensityValue);
                                emotion_intensity_before = 5;
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏:', error);
                    }
                    
                    let emotion_intensity_after = 5;  // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    try {
                        const changeValue = window.userResponses['emotionChange'];
                        if (changeValue) {
                            emotion_intensity_after = parseInt(changeValue, 10);
                            if (isNaN(emotion_intensity_after)) {
                                console.warn('‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º:', changeValue);
                                emotion_intensity_after = 5;
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏:', error);
                    }
                    
                    // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–ª—é—á–µ–π –≤ userResponses –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ polyfill
                    const analysisData = {
                        situation: window.userResponses['situation'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        thoughts: window.userResponses['thoughts'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion: window.userResponses['emotions'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion_intensity_before: window.userResponses['intensity'] || 5,
                        physical_reaction: window.userResponses['body'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        evidence_for: window.userResponses['evidence_for'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        evidence_against: window.userResponses['evidence_against'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        rational_perspective: window.userResponses['reframe'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion_intensity_after: window.userResponses['emotion_change'] || 5,
                        future_coping: window.userResponses['future_plan'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
                    };
                    
                    console.log('üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', analysisData);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    let authHeaders = {
                        'Content-Type': 'application/json'
                    };
                    
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                    const userData = localStorage.getItem('telegramUser') || 
                                     localStorage.getItem('user') || 
                                     localStorage.getItem('userData');
                    
                    // –ü—Ä–æ–±—É–µ–º —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
                    const authToken = localStorage.getItem('token') || 
                                      localStorage.getItem('auth_token') || 
                                      localStorage.getItem('authToken');
                    
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage:', userData);
                    console.log('–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ localStorage:', authToken);
                    
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–æ–∫–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    if (authToken) {
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', authToken);
                        authHeaders['Authorization'] = `Bearer ${authToken}`;
                    }
                    
                    if (userData) {
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage:', userData);
                        try {
                            // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –µ—Å–ª–∏ —ç—Ç–æ JSON —Å—Ç—Ä–æ–∫–∞
                            const parsedUserData = JSON.parse(userData);
                            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã:', parsedUserData);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ userData –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                            if (typeof parsedUserData === 'object') {
                                // –ï—Å–ª–∏ –µ—Å—Ç—å token –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                                if (parsedUserData.token) {
                                    authHeaders['Authorization'] = `Bearer ${parsedUserData.token}`;
                                }
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                                Object.keys(parsedUserData).forEach(key => {
                                    const value = parsedUserData[key];
                                    if (value) {
                                        authHeaders[`X-User-${key}`] = String(value);
                                    }
                                });
                                
                                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                                authHeaders['X-User-Data'] = userData;
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É:', e);
                            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—É—é —Å—Ç—Ä–æ–∫—É
                            authHeaders['X-User-Data'] = userData;
                            if (!authHeaders['Authorization']) {
                                authHeaders['Authorization'] = `Bearer ${userData}`;
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º soft_validation=1 –∫ URL
                    const apiUrl = '/api/save-cbt-analysis?soft_validation=1';
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API:', apiUrl);
                    console.log('üì§ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', authHeaders);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: authHeaders,
                        body: JSON.stringify(analysisData),
                        credentials: 'include' // –î–æ–±–∞–≤–ª—è–µ–º cookies –∫ –∑–∞–ø—Ä–æ—Å—É
                    });
                    
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API, —Å—Ç–∞—Ç—É—Å:', response.status);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ${response.status}:`, errorText);
                        throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const result = await response.json();
                    console.log('üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:', result);
                    
                    if (result.success) {
                        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ID:', result.analysis_id);
                        
                        // –û—Ç–º–µ—á–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                        const today = new Date();
                        const todayString = today.toISOString().split('T')[0];
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤ localStorage
                        localStorage.setItem('lastJournalCompletedDate', todayString);
                        localStorage.setItem('journalCompletedToday', 'true');
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
                        localStorage.setItem('journalCompleted', 'true');
                        
                        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ—Ç–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
                        if (typeof markJournalCompleted === 'function') {
                            markJournalCompleted(todayString, '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞');
                        }
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:', result.error);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:', error);
                    throw error;
                }
            }
        });
        
        // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ soft_validation
        document.addEventListener('DOMContentLoaded', function() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
            if (isMobile) {
                document.body.setAttribute('data-mobile', 'true');
                document.body.setAttribute('data-soft-validation', 'true');
                console.log("Mobile device detected, enabling soft validation mode");
                
                // –ü–∞—Ç—á–∏–º fetch –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ soft_validation=1 –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º –∫ –Ω–∞—à–µ–º—É API
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    if (typeof url === 'string' && url.includes('/api/')) {
                        // –î–ª—è API-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä soft_validation=1
                        const urlObj = new URL(url, window.location.origin);
                        urlObj.searchParams.set('soft_validation', '1');
                        url = urlObj.toString();
                    }
                    return originalFetch.call(this, url, options);
                };
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —Ñ—É–Ω–∫—Ü–∏–π
            const understandingCard = document.getElementById('understandingCard');
            const journalCard = document.getElementById('journalCard');
            const completedCard = document.getElementById('completedCard');
            
            if (understandingCard) {
                understandingCard.addEventListener('click', function() {
                    // –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É "–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–µ–±—è"
                    console.log('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç–∞—Ç—å—è–º –æ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏');
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å—Ç–∞—Ç—å—è–º–∏
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫" —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ,
            // –≥–¥–µ –æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–∏
            
            if (completedCard) {
                completedCard.addEventListener('click', function() {
                    // –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ø—Ä–æ–π–¥–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    console.log('–í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª');
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –∫ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            function resetCardStatus(card, indicator) {
                if (card) {
                    card.classList.remove('completed');
                    card.classList.add('active');
                }
                
                if (indicator) {
                    indicator.classList.remove('completed');
                    indicator.classList.add('active');
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —É–º–Ω–æ–≥–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.remove('completed');
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
                const journalCard = document.getElementById('journalCard');
                if (journalCard) {
                    journalCard.classList.remove('completed');
                    journalCard.classList.add('active');
                }
                
                console.log('–°–±—Ä–æ—à–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø—Ä–æ—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —É—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è
            function checkTodayLessonProgress() {
                // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫—É—Ä—Å–æ–≤ –∏ –µ—ë –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const coursesCard = document.getElementById('coursesCard');
                const coursesIndicator = document.getElementById('coursesIndicator');
                
                // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ)
                resetCardStatus(coursesCard, coursesIndicator);
                
                // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                const lastCompletedDate = localStorage.getItem('lastLessonCompletedDate');
                const lastCompletedStatus = localStorage.getItem('lessonCompletedToday');
                
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (lastCompletedDate === todayString && lastCompletedStatus === 'true') {
                    markCardCompleted(coursesCard, coursesIndicator, todayString, '–∫—ç—à localStorage');
                    return;
                }
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤
                fetch('/api/courses?soft_validation=1')
                    .then(response => {
                        if (!response.ok) {
                            console.warn('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫—É—Ä—Å–æ–≤:', response.status, response.statusText);
                            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—Å–∞—Ö: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            if (data.progress && data.progress.completed_lessons && data.progress.completed_lessons.length > 0) {
                                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —É—Ä–æ–∫–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –±—ã–ª –ø—Ä–æ–π–¥–µ–Ω —É—Ä–æ–∫
                                const lastAccessed = data.progress.last_accessed;
                                
                                if (lastAccessed && lastAccessed.startsWith(todayString)) {
                                    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø –±—ã–ª —Å–µ–≥–æ–¥–Ω—è, –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
                                    markCardCompleted(coursesCard, coursesIndicator, todayString, '–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å');
                                } else {
                                    console.log('–ï—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –±–∞–∑–µ, –Ω–æ –Ω–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:', lastAccessed);
                                }
                            } else {
                                console.log('–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫—É—Ä—Å–æ–≤:', error);
                        
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mood-data –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                        fetchWithAuth('/api/mood-data?soft_validation=1')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–ø–∞—Å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    const todayEntry = data.moodEntries.find(entry => 
                                        entry.date.startsWith(todayString)
                                    );
                                    
                                    if (todayEntry) {
                                        // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω
                                        markCardCompleted(coursesCard, coursesIndicator, todayString, '–¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è');
                                    }
                                }
                            })
                            .catch(err => {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ:', err);
                                // –ù–µ –¥–µ–ª–∞–µ–º –Ω–∏—á–µ–≥–æ, –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É –æ—à–∏–±–∫—É
                            });
                    });
            }
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
            function markCardCompleted(card, indicator, dateString, source) {
                if (card) {
                    card.classList.remove('active');
                    card.classList.add('completed');
                }
                
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.classList.add('completed');
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫" –µ—Å–ª–∏ —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.add('active');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ localStorage
                localStorage.setItem('lastLessonCompletedDate', dateString);
                localStorage.setItem('lessonCompletedToday', 'true');
                
                console.log(`–ö–∞—Ä—Ç–æ—á–∫–∞ –∫—É—Ä—Å–æ–≤ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ (–∏—Å—Ç–æ—á–Ω–∏–∫: ${source})`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                saveUserStatus({
                    lesson_completed: true
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
            function markJournalCompleted(dateString, source) {
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                if (journalCard) {
                    journalCard.classList.remove('active');
                    journalCard.classList.add('completed');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.add('completed');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                userProgress.markJournalCompleted();
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø–æ–ª–Ω–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ —Å–µ–≥–æ–¥–Ω—è
            function checkTodayJournalProgress() {
                // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ –∏ –µ—ë –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                const lastCompletedDate = localStorage.getItem('lastJournalCompletedDate');
                const lastCompletedStatus = localStorage.getItem('journalCompletedToday');
                
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (lastCompletedDate === todayString && lastCompletedStatus === 'true') {
                    markJournalCompleted(todayString, '–∫—ç—à localStorage');
                    return;
                }
                
                // –î—Ä—É–≥–∏–µ —Å–ø–æ—Å–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å
                // –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API
            }
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            setTimeout(checkTodayLessonProgress, 500);
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
            setTimeout(checkTodayJournalProgress, 600);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏, —á—Ç–æ —É—Ä–æ–∫ –±—ã–ª –ø—Ä–æ–π–¥–µ–Ω
            window.addEventListener('storage', function(e) {
                // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞
                if (e.key === 'lessonCompleted') {
                    // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫—É—Ä—Å–æ–≤ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    const coursesCard = document.getElementById('coursesCard');
                    const coursesIndicator = document.getElementById('coursesIndicator');
                    
                    if (coursesCard) {
                        // –û—Ç–º–µ—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
                        markCardCompleted(coursesCard, coursesIndicator, todayString, '—Å–æ–±—ã—Ç–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
                    }
                }
                // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
                else if (e.key === 'journalCompleted') {
                    // –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    
                    // –û—Ç–º–µ—á–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π
                    markJournalCompleted(todayString, '—Å–æ–±—ã—Ç–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
                }
            });
            
            // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫—É—Ä—Å–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            const coursesCard = document.getElementById('coursesCard');
            if (coursesCard) {
                coursesCard.addEventListener('click', function() {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–µ—Ç–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫—É—Ä—Å–æ–≤
                    localStorage.setItem('visitedCoursesPage', 'true');
                });
            }
            
            // –£–¥–∞–ª—è—é –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è journalCard
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ç–∞–π–º–ª–∞–π–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫
            function positionTimelineIndicators() {
                const cards = document.querySelectorAll('.feature-card');
                const indicators = document.querySelectorAll('.timeline-indicator');
                const timeline = document.querySelector('.features-timeline');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω—ã –ª–∏ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (!cards.length || !indicators.length || !timeline) {
                    console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞');
                    return;
                }
                
                // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–∞—Ä—Ç–æ—á–µ–∫
                if (cards.length === indicators.length) {
                    let firstIndicatorTop = 0;
                    let lastIndicatorTop = 0;
                    
                    cards.forEach((card, index) => {
                        const indicator = indicators[index];
                        const cardRect = card.getBoundingClientRect();
                        const containerRect = card.parentElement.getBoundingClientRect();
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Å–µ—Ä–µ–¥–∏–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        const cardMiddle = cardRect.top + cardRect.height / 2 - containerRect.top;
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
                        indicator.style.top = cardMiddle + 'px';
                        
                        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–µ—Ä–≤–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
                        if (index === 0) {
                            firstIndicatorTop = cardMiddle;
                        }
                        if (index === cards.length - 1) {
                            lastIndicatorTop = cardMiddle;
                        }
                    });
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é, —á—Ç–æ–±—ã –æ–Ω–∞ —à–ª–∞ —Ç–æ–ª—å–∫–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
                    timeline.style.top = firstIndicatorTop + 'px';
                    timeline.style.height = (lastIndicatorTop - firstIndicatorTop) + 'px';
                    
                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ timeline –≤–∏–¥–µ–Ω
                    timeline.style.display = 'block';
                }
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            setTimeout(function() {
                console.log('–í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ timeline —ç–ª–µ–º–µ–Ω—Ç–æ–≤...');
                positionTimelineIndicators();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const timeline = document.querySelector('.features-timeline');
                if (timeline) {
                    console.log('Timeline —Å—Ç–∏–ª–∏:', {
                        display: timeline.style.display,
                        top: timeline.style.top,
                        height: timeline.style.height
                    });
                }
            }, 100);
            
            // –ò —Ç–∞–∫–∂–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', positionTimelineIndicators);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            setTimeout(initMoodCalendar, 1000);
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–∞
            const chatOverlay = document.getElementById('chatOverlay');
            const chatClose = document.getElementById('chatClose');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            const journalCard = document.getElementById('journalCard');
            if (journalCard) {
                journalCard.addEventListener('click', function(event) {
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
                    event.preventDefault();
                    
                    // –†—É—á–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –±–µ–∑ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ openChat
                    if (chatOverlay) {
                        chatOverlay.classList.add('active');
                        
                        const chatContainer = document.getElementById('chatContainer');
                        if (chatContainer) {
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
                            chatContainer.style.opacity = '0';
                            chatContainer.style.transform = 'translateY(20px)';
                            
                            // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
                            setTimeout(() => {
                                chatContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                chatContainer.style.opacity = '1';
                                chatContainer.style.transform = 'translateY(0)';
                            }, 10);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (chatMessages) {
                            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                            chatMessages.innerHTML = '';
                            
                            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞
                            const message = document.createElement('div');
                            message.className = 'message message-bot';
                            message.textContent = "–û–ø–∏—à–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ, –≤—ã–∑–≤–∞–≤—à–µ–µ —Å–∏–ª—å–Ω—ã–µ —ç–º–æ—Ü–∏–∏. –ì–¥–µ, –∫–æ–≥–¥–∞, —Å –∫–µ–º —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?";
                            chatMessages.appendChild(message);
                        }
                        
                        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                        setTimeout(() => {
                            const userInput = document.getElementById('userInput');
                            if (userInput) {
                                userInput.focus();
                            }
                        }, 300);
                    }
                    
                    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–∏');
                });
                console.log('–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ "–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫"');
            } else {
                console.error('–≠–ª–µ–º–µ–Ω—Ç journalCard –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
            const chatCloseButton = document.getElementById('chatCloseButton');
            if (chatCloseButton) {
                chatCloseButton.addEventListener('click', function() {
                    // –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
                    if (chatOverlay) {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
                        const chatContainer = document.getElementById('chatContainer');
                        if (chatContainer) {
                            // –ê–Ω–∏–º–∏—Ä—É–µ–º –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ
                            chatContainer.style.opacity = '0';
                            chatContainer.style.transform = 'translateY(20px)';
                            
                            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å active —É –æ–≤–µ—Ä–ª–µ—è –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                            setTimeout(() => {
                                chatOverlay.classList.remove('active');
                                // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
                                chatContainer.style.transition = '';
                            }, 300);
                        } else {
                            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                            chatOverlay.classList.remove('active');
                        }
                    }
                    
                    console.log('–ó–∞–∫—Ä—ã—Ç —á–∞—Ç –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è');
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            const sendButton = document.getElementById('sendButton');
            const userInput = document.getElementById('userInput');
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            function addUserMessage(text) {
                if (!chatMessages) return;
                
                const message = document.createElement('div');
                message.className = 'message message-user';
                message.textContent = text;
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            function handleSendMessage() {
                if (!userInput) return;
                
                const text = userInput.value.trim();
                if (text) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    addUserMessage(text);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userResponses.push(text);
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    userInput.value = '';
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                    currentQuestionIndex++;
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –≤—Ç–æ—Ä–æ–π –≤–æ–ø—Ä–æ—Å (–∏–Ω–¥–µ–∫—Å 1), –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–Ω–∞–ª–∏–∑—É —ç–º–æ—Ü–∏–π
                    if (currentQuestionIndex === 2) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º –±–æ—Ç–∞
                        setTimeout(async () => {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø—Ä–æ —ç–º–æ—Ü–∏–∏
                            const botMessage = document.createElement('div');
                            botMessage.className = 'message message-bot';
                            botMessage.textContent = chatQuestions[currentQuestionIndex].text;
                            chatMessages.appendChild(botMessage);
                            
                            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            
                            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —ç–º–æ—Ü–∏–π
                            setTimeout(async () => {
                                try {
                                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —ç–º–æ—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
                                    const emotions = ['–†–∞–¥–æ—Å—Ç—å', '–ì—Ä—É—Å—Ç—å', '–°—Ç—Ä–∞—Ö', '–ì–Ω–µ–≤', '–¢—Ä–µ–≤–æ–≥–∞', '–†–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ', '–£–¥–∏–≤–ª–µ–Ω–∏–µ', '–°—Ç—ã–¥', '–í–∏–Ω–∞', '–õ—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ'];
                                    
                                    // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —ç–º–æ—Ü–∏–π
                                    const emotionBlock = document.createElement('div');
                                    emotionBlock.className = 'message message-bot';
                
                let buttonsHTML = '<div class="emotion-buttons">';
                emotions.forEach(emotion => {
                    buttonsHTML += `<button class="emotion-button">${emotion}</button>`;
                });
                buttonsHTML += '</div>';
                
                                    emotionBlock.innerHTML = buttonsHTML;
                                    chatMessages.appendChild(emotionBlock);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π
                                    const emotionButtons = emotionBlock.querySelectorAll('.emotion-button');
                emotionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
                        emotionButtons.forEach(btn => btn.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é
                        const selectedEmotion = this.textContent;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —ç–º–æ—Ü–∏—é –∫–∞–∫ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (typeof addUserMessage === 'function') {
                            addUserMessage(selectedEmotion);
                        } else if (typeof window.addUserMessage === 'function') {
                            window.addUserMessage(selectedEmotion);
                        } else {
                            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                            const userMsg = document.createElement('div');
                            userMsg.className = 'message-wrapper user-message';
                            userMsg.innerHTML = `
                                <div class="message-container">
                                    <div class="message-text">${selectedEmotion}</div>
                                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            `;
                            chatMessages.appendChild(userMsg);
                            userMsg.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ userResponses
                        if (typeof window.userResponses === 'object') {
                            window.userResponses['emotions'] = selectedEmotion;
                        } else {
                            console.error("‚ùå –û—à–∏–±–∫–∞: window.userResponses –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º!");
                        }
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
                        window.currentQuestionIndex++;
                        
                            setTimeout(() => {
                            addBotMessage(chatQuestions[currentQuestionIndex].text);
                            }, 500);
                    });
                });
                                } catch (error) {
                                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–Ω–æ–ø–æ–∫ —ç–º–æ—Ü–∏–π:', error);
                                    
                                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
                                    currentQuestionIndex++;
                                    addBotMessage(chatQuestions[currentQuestionIndex].text);
                                }
                        }, 500);
                        }, 500);
                    } else {
                        // –î–ª—è –¥—Ä—É–≥–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–≤–µ—Ç–æ–º –±–æ—Ç–∞ 
                            setTimeout(() => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã
                            if (currentQuestionIndex < chatQuestions.length) {
                                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                                const message = document.createElement('div');
                                message.className = 'message message-bot';
                                message.textContent = chatQuestions[currentQuestionIndex].text;
                                chatMessages.appendChild(message);
                                
                                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                
                                // –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –æ–± –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏
                                if (currentQuestionIndex === 8) {
                            setTimeout(() => {
                                        createEmotionIntensitySlider();
                                    }, 300);
                                }
                            } else {
                                // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const message = document.createElement('div');
                message.className = 'message message-bot';
                                message.textContent = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã! –≠—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ–º–æ–≥ –≤–∞–º –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏ –∏ –º—ã—Å–ª–∏. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —á–∞—Ç–∞ –∏–ª–∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.";
                chatMessages.appendChild(message);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –≤–Ω–∏–∑
                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                    }, 500);
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
            if (sendButton) {
                sendButton.addEventListener('click', handleSendMessage);
                console.log('–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            } else {
                console.error('–≠–ª–µ–º–µ–Ω—Ç sendButton –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            if (userInput) {
                userInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleSendMessage();
                    }
                });
                console.log('–î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞');
                    } else {
                console.error('–≠–ª–µ–º–µ–Ω—Ç userInput –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
        window.resetLessonProgress = function() {
            // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ —É—Ä–æ–∫–æ–≤
            localStorage.removeItem('lastLessonCompletedDate');
            localStorage.removeItem('lessonCompletedToday');
            localStorage.removeItem('lessonCompleted');
            
            // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞
            localStorage.removeItem('lastJournalCompletedDate');
            localStorage.removeItem('journalCompletedToday');
            localStorage.removeItem('journalCompleted');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            const coursesCard = document.getElementById('coursesCard');
            const coursesIndicator = document.getElementById('coursesIndicator');
            const journalIndicator = document.getElementById('journalIndicator');
            const journalCard = document.getElementById('journalCard');
            
            if (coursesCard) {
                coursesCard.classList.remove('completed');
                coursesCard.classList.add('active');
            }
            
            if (coursesIndicator) {
                coursesIndicator.classList.remove('completed');
                coursesIndicator.classList.add('active');
            }
            
            if (journalIndicator) {
                journalIndicator.classList.remove('active');
                journalIndicator.classList.remove('completed');
            }
            
            if (journalCard) {
                journalCard.classList.remove('completed');
                journalCard.classList.add('active');
            }
            
            console.log('–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —É—Ä–æ–∫–∞ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ –æ—á–∏—â–µ–Ω—ã. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–±—Ä–æ—à–µ–Ω–æ.');
            return '–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–∫–∞ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω';
        };
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–∞—Ç–∞
        setTimeout(function() {
            console.log("=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ß–ê–¢–ê ===");
            console.log("journalCard —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('journalCard'));
            console.log("chatOverlay —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('chatOverlay'));
            console.log("chatContainer —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('chatContainer'));
            console.log("openChat —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", typeof window.openChat === 'function');
            console.log("chatQuestions —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", typeof window.chatQuestions !== 'undefined');
            console.log("chatMessages —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('chatMessages'));
            console.log("userInput —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('userInput'));
            console.log("chatClose —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('chatClose'));
            console.log("chatCloseButton —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('chatCloseButton'));
            console.log("sendButton —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", !!document.getElementById('sendButton'));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
            console.log("=== –ü–†–û–í–ï–†–ö–ê –û–ë–õ–ê–°–¢–ï–ô –í–ò–î–ò–ú–û–°–¢–ò ===");
            try {
                const journalCard = document.getElementById('journalCard');
                if (journalCard) {
                    console.log("–î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ journalCard");
                    journalCard.addEventListener('click', function(event) {
                        console.log("–ö–ª–∏–∫ –Ω–∞ journalCard –æ–±—Ä–∞–±–æ—Ç–∞–Ω");
                        
                        // –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è openChat –≤—Ä—É—á–Ω—É—é
                        console.log("–ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –≤—Ä—É—á–Ω—É—é");
                        try {
                            const chatOverlay = document.getElementById('chatOverlay');
                            if (chatOverlay) {
                                chatOverlay.classList.add('active');
                                console.log("chatOverlay.active —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
                            }
                            
                            const chatContainer = document.getElementById('chatContainer');
                            if (chatContainer) {
                                chatContainer.style.opacity = '1';
                                chatContainer.style.transform = 'translateY(0)';
                                chatContainer.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                console.log("–ê–Ω–∏–º–∞—Ü–∏—è chatContainer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
                            }
                        } catch (e) {
                            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:", e);
                        }
                    });
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:", e);
            }
            
            console.log("=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===");
        }, 1000);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–π
        window.CBTModule = (function() {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
            async function saveAnalysisResults() {
                try {
                    console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');
                    console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ userResponses:', window.userResponses);
                    
                    if (!window.userResponses) {
                        console.error('‚ùå –û–±—ä–µ–∫—Ç userResponses –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                        throw new Error('–û–±—ä–µ–∫—Ç userResponses –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤:', Object.keys(window.userResponses).length);
                    
                    if (Object.keys(window.userResponses).length < 8) {
                        console.error('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è! –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 8, –ø–æ–ª—É—á–µ–Ω–æ ' + Object.keys(window.userResponses).length);
                        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                    const requiredQuestions = ['situation', 'thoughts', 'emotions', 'body', 
                                               'evidence_for', 'evidence_against', 'reframe', 'future_plan'];
                    let missingQuestions = [];
                    
                    for (let questionId of requiredQuestions) {
                        if (!window.userResponses[questionId]) {
                            missingQuestions.push(questionId);
                        }
                    }
                    
                    if (missingQuestions.length > 0) {
                        console.warn('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:', missingQuestions);
                        console.log('–ò–º–µ—é—â–∏–µ—Å—è –æ—Ç–≤–µ—Ç—ã:', Object.keys(window.userResponses));
                        if (missingQuestions.length > 3) {
                            throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã: ${missingQuestions.join(', ')}`);
                        }
                    }
                    
                    // –ò–ó–ú–ï–ù–ï–ù–û: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∫ —á–∏—Å–ª–∞, —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                    let emotion_intensity_before = 5;  // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    try {
                        const intensityValue = window.userResponses['intensity'];
                        if (intensityValue) {
                            emotion_intensity_before = parseInt(intensityValue, 10);
                            if (isNaN(emotion_intensity_before)) {
                                console.warn('‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º:', intensityValue);
                                emotion_intensity_before = 5;
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏:', error);
                    }
                    
                    let emotion_intensity_after = 5;  // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    try {
                        const changeValue = window.userResponses['emotionChange'];
                        if (changeValue) {
                            emotion_intensity_after = parseInt(changeValue, 10);
                            if (isNaN(emotion_intensity_after)) {
                                console.warn('‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º:', changeValue);
                                emotion_intensity_after = 5;
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —ç–º–æ—Ü–∏–∏:', error);
                    }
                    
                    // –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–ª—é—á–µ–π –≤ userResponses –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ polyfill
                    const analysisData = {
                        situation: window.userResponses['situation'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        thoughts: window.userResponses['thoughts'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion: window.userResponses['emotions'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion_intensity_before: window.userResponses['intensity'] || 5,
                        physical_reaction: window.userResponses['body'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        evidence_for: window.userResponses['evidence_for'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        evidence_against: window.userResponses['evidence_against'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        rational_perspective: window.userResponses['reframe'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                        emotion_intensity_after: window.userResponses['emotion_change'] || 5,
                        future_coping: window.userResponses['future_plan'] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
                    };
                    
                    console.log('üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', analysisData);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    let authHeaders = {
                        'Content-Type': 'application/json'
                    };
                    
                    // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                    const userData = localStorage.getItem('telegramUser') || 
                                     localStorage.getItem('user') || 
                                     localStorage.getItem('userData');
                    
                    // –ü—Ä–æ–±—É–µ–º —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –Ω–∞–ø—Ä—è–º—É—é
                    const authToken = localStorage.getItem('token') || 
                                      localStorage.getItem('auth_token') || 
                                      localStorage.getItem('authToken');
                    
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage:', userData);
                    console.log('–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ localStorage:', authToken);
                    
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–æ–∫–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    if (authToken) {
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', authToken);
                        authHeaders['Authorization'] = `Bearer ${authToken}`;
                    }
                    
                    if (userData) {
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage:', userData);
                        try {
                            // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, –µ—Å–ª–∏ —ç—Ç–æ JSON —Å—Ç—Ä–æ–∫–∞
                            const parsedUserData = JSON.parse(userData);
                            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã:', parsedUserData);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ userData –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                            if (typeof parsedUserData === 'object') {
                                // –ï—Å–ª–∏ –µ—Å—Ç—å token –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                                if (parsedUserData.token) {
                                    authHeaders['Authorization'] = `Bearer ${parsedUserData.token}`;
                                }
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                                Object.keys(parsedUserData).forEach(key => {
                                    const value = parsedUserData[key];
                                    if (value) {
                                        authHeaders[`X-User-${key}`] = String(value);
                                    }
                                });
                                
                                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                                authHeaders['X-User-Data'] = userData;
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É:', e);
                            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—É—é —Å—Ç—Ä–æ–∫—É
                            authHeaders['X-User-Data'] = userData;
                            if (!authHeaders['Authorization']) {
                                authHeaders['Authorization'] = `Bearer ${userData}`;
                            }
                        }
                    } else {
                        console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º soft_validation=1 –∫ URL
                    const apiUrl = '/api/save-cbt-analysis?soft_validation=1';
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API:', apiUrl);
                    console.log('üì§ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', authHeaders);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: authHeaders,
                        body: JSON.stringify(analysisData),
                        credentials: 'include' // –î–æ–±–∞–≤–ª—è–µ–º cookies –∫ –∑–∞–ø—Ä–æ—Å—É
                    });
                    
                    console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç API, —Å—Ç–∞—Ç—É—Å:', response.status);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ${response.status}:`, errorText);
                        throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const result = await response.json();
                    console.log('üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:', result);
                    
                    if (result.success) {
                        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ID:', result.analysis_id);
                        
                        // –û—Ç–º–µ—á–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                        const today = new Date();
                        const todayString = today.toISOString().split('T')[0];
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤ localStorage
                        localStorage.setItem('lastJournalCompletedDate', todayString);
                        localStorage.setItem('journalCompletedToday', 'true');
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º
                        localStorage.setItem('journalCompleted', 'true');
                        
                        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ—Ç–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ (–µ—Å–ª–∏ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
                        if (typeof markJournalCompleted === 'function') {
                            markJournalCompleted(todayString, '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞');
                        }
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:', result.error);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞:', error);
                    throw error;
                }
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é saveAnalysisResults
            return {
                saveAnalysisResults: saveAnalysisResults
            };
        })();
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞–ø—Ä—è–º—É—é
        window.saveAnalysisResults = window.CBTModule.saveAnalysisResults;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ saveAnalysisResults:');
        console.log('typeof window.saveAnalysisResults:', typeof window.saveAnalysisResults);
        if (typeof window.saveAnalysisResults === 'function') {
            console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è saveAnalysisResults —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window');
        } else {
            console.error('‚ùå –û–®–ò–ë–ö–ê: –§—É–Ω–∫—Ü–∏—è saveAnalysisResults –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window');
            // –ü—Ä–æ–±—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
            window.saveAnalysisResults = function() {
                console.log('–í—ã–∑–≤–∞–Ω–∞ –∑–∞–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è saveAnalysisResults');
                if (window.CBTModule && typeof window.CBTModule.saveAnalysisResults === 'function') {
                    return window.CBTModule.saveAnalysisResults();
                } else {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é saveAnalysisResults');
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é saveAnalysisResults');
                }
            };
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ª–∞–¥–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
        window.debugSaveResults = function() {
            console.log('üîß –†–£–ß–ù–û–ô –í–´–ó–û–í –°–û–•–†–ê–ù–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í');
            console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ window.userResponses:', window.userResponses);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤
            const requiredQuestions = ['situation', 'thoughts', 'emotions', 'intensity', 'body', 
                                      'evidence_for', 'evidence_against', 'reframe', 'emotionChange', 'futurePlan'];
            
            for (let questionId of requiredQuestions) {
                if (!window.userResponses[questionId]) {
                    console.log(`‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å ${questionId}, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ`);
                    window.userResponses[questionId] = `–¢–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å ${questionId}`;
                }
            }
            
            console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:', Object.keys(window.userResponses).length);
            
            if (typeof window.saveAnalysisResults === 'function') {
                return window.saveAnalysisResults()
                    .then(result => {
                        console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (debug):', result);
                        return result;
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (debug):', error);
                        throw error;
                    });
            } else {
                console.error('‚ùå –§—É–Ω–∫—Ü–∏—è saveAnalysisResults –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ window!');
                throw new Error('–§—É–Ω–∫—Ü–∏—è saveAnalysisResults –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ saveAnalysisResults:');
        console.log('typeof window.saveAnalysisResults:', typeof window.saveAnalysisResults);
        if (typeof window.saveAnalysisResults === 'function') {
            console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è saveAnalysisResults —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window');
        } else {
            console.error('‚ùå –û–®–ò–ë–ö–ê: –§—É–Ω–∫—Ü–∏—è saveAnalysisResults –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç window');
            // –ü—Ä–æ–±—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
            window.saveAnalysisResults = function() {
                console.log('–í—ã–∑–≤–∞–Ω–∞ –∑–∞–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è saveAnalysisResults');
                if (window.CBTModule && typeof window.CBTModule.saveAnalysisResults === 'function') {
                    return window.CBTModule.saveAnalysisResults();
                } else {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é saveAnalysisResults');
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é saveAnalysisResults');
                }
            };
        }
        
        // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ soft_validation
    </script>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function isFirstSession() {
            try {
                return localStorage.getItem('hasCompletedOnboarding') !== 'true';
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏:", error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏, —á—Ç–æ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–æ–π–¥–µ–Ω
        function markOnboardingCompleted() {
            try {
                localStorage.setItem('hasCompletedOnboarding', 'true');
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:", error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
        function startOnboarding() {
            // –®–∞–≥ 1: –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            showOnboardingStep(1);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–∞–≥–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
        function showOnboardingStep(step) {
            const speechBubble = document.querySelector('.speech-bubble');
            if (!speechBubble) return;
            
            // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
            const steps = {
                1: {
                    content: `
                        –ü—Ä–∏–≤–µ—Ç! –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç–≤–æ–π —Ä–∞–∑—É–º ‚Äî —ç—Ç–æ –∫–æ–º–ø—å—é—Ç–µ—Ä, –≥–¥–µ –∏–Ω–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–∞–π—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∏—Ö.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext1">–î–∞–ª–µ–µ</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(2)
                },
                2: {
                    content: `
                        –ö–∞–∂–¥–∞—è —Å–∏–ª—å–Ω–∞—è —ç–º–æ—Ü–∏—è ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª. –ù–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–¥–∏–≤—ã–π. –ö–æ–≥–¥–∞ —Ç—ã —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω, —Ç–≤–æ–π –º–æ–∑–≥ —á–∞—Å—Ç–æ –≤—ã–¥–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º—ã—Å–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ —É—Å–∏–ª–∏–≤–∞—é—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext2">–î–∞–ª–µ–µ</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(3)
                },
                3: {
                    content: `
                        –í–æ—Ç –≤ —á–µ–º —Å–µ–∫—Ä–µ—Ç: –∏–∑–º–µ–Ω–∏–≤ –æ–¥–Ω—É –º—ã—Å–ª—å, —Ç—ã –º–µ–Ω—è–µ—à—å –≤—Å—é —Ü–µ–ø–æ—á–∫—É —Ä–µ–∞–∫—Ü–∏–π! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —É–≤–∏–¥–µ—Ç—å —ç—Ç–∏ –º—ã—Å–ª–∏ –∏ –Ω–∞–π—Ç–∏ –∏–º –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É ‚Äî –∏ —Ç–≤–æ—è –∂–∏–∑–Ω—å –Ω–∞—á–Ω–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø—Ä—è–º–æ –Ω–∞ –≥–ª–∞–∑–∞—Ö.
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingNext3">–î–∞–ª–µ–µ</button>
                        </div>
                    `,
                    buttonHandler: () => showOnboardingStep(4)
                },
                4: {
                    content: `
                        –Ø —Ç–µ–±–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π—Ç–∏ –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–π–º–µ—Ç 5 –º–∏–Ω—É—Ç, —Ç—ã —Å–º–æ–∂–µ—à—å –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤–Ω–µ–¥—Ä–∏—Ç—å –≤ —Å–≤–æ—é –∂–∏–∑–Ω—å
                        <div class="speech-bubble-actions">
                            <button class="action-button analyze-button" id="onboardingStart">–ù–∞—á–∞—Ç—å</button>
                            <button class="action-button skip-button" id="onboardingSkip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                        </div>
                    `,
                    buttonHandler: (isStart) => {
                        markOnboardingCompleted();
                        if (isStart) {
                            window.location.href = '/courses';
                        } else {
                            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç, —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                            const speechBubble = document.querySelector('.speech-bubble');
                            if (speechBubble) {
                                speechBubble.innerHTML = `
                                    –ü—Ä–∏–≤–µ—Ç! –•–æ—á–µ—à—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ —Å–∏—Ç—É–∞—Ü–∏–∏?
                                    <div class="speech-bubble-actions">
                                        <button class="action-button analyze-button" id="analyzeButton">–î–∞, –¥–∞–≤–∞–π</button>
                                        <button class="action-button skip-button" id="skipButton">–ù–µ –Ω—É–∂–Ω–æ</button>
                                    </div>
                                `;
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
                                const analyzeButton = document.getElementById('analyzeButton');
                                const skipButton = document.getElementById('skipButton');
                                
                                if (analyzeButton) {
                                    analyzeButton.addEventListener('click', openChat);
                                }
                                
                                if (skipButton) {
                                    skipButton.addEventListener('click', function() {
                                        speechBubble.innerHTML = `
                                            –•–æ—Ä–æ—à–æ, –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç —Ç—ã –º–æ–∂–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è, –∏ —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π
                                            <div class="speech-bubble-actions">
                                                <button class="action-button analyze-button" id="analyzeAfterSkip">–†–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏</button>
                                            </div>
                                        `;
                                        
                                        const analyzeAfterSkip = document.getElementById('analyzeAfterSkip');
                                        if (analyzeAfterSkip) {
                                            analyzeAfterSkip.addEventListener('click', openChat);
                                        }
                                    });
                                }
                            }
                        }
                    },
                    animateCoursesCard: true
                }
            };
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
            const currentStep = steps[step];
            if (!currentStep) return;
            
            speechBubble.innerHTML = currentStep.content;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
            const buttonId = `onboardingNext${step}`;
            const button = document.getElementById(buttonId) || document.getElementById('onboardingStart');
            if (button) {
                button.addEventListener('click', function() {
                    if (step === 4) {
                        currentStep.buttonHandler(true);
                    } else {
                        currentStep.buttonHandler();
                    }
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –Ω–∞ —à–∞–≥–µ 4
            if (step === 4) {
                const skipButton = document.getElementById('onboardingSkip');
                if (skipButton) {
                    skipButton.addEventListener('click', function() {
                        currentStep.buttonHandler(false);
                    });
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—É—Ä—Å–æ–≤
                setTimeout(() => {
                    animateCoursesCard();
                }, 5000); // 5 —Å–µ–∫—É–Ω–¥
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫—É—Ä—Å–æ–≤
        function animateCoursesCard() {
            const coursesCard = document.getElementById('coursesCard');
            if (!coursesCard) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            coursesCard.classList.add('attention-animation');
            
            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                coursesCard.classList.remove('attention-animation');
            }, 2000);
        }
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
        document.addEventListener('DOMContentLoaded', function() {
            if (isFirstSession()) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                startOnboarding();
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∏–∑ localStorage
                const lessonCompleted = localStorage.getItem('lessonCompletedToday') === 'true';
                const journalCompleted = localStorage.getItem('journalCompletedToday') === 'true';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                const speechBubble = document.querySelector('.speech-bubble');
                if (speechBubble) {
                    let message = '';
                    let buttons = '';
                    
                    if (!lessonCompleted && !journalCompleted) {
                        message = '–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–Ω–∏ —Å–≤–æ–π –¥–µ–Ω—å —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —É—Ä–æ–∫–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–∏.';
                    } else if (lessonCompleted && !journalCompleted) {
                        message = '–û—Ç–ª–∏—á–Ω–æ, —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω, –¥–∞–≤–∞–π—Ç–µ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–≤–æ–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–µ.';
                    } else if (!lessonCompleted && journalCompleted) {
                        message = '–ó–¥–æ—Ä–æ–≤–æ, —á—Ç–æ —Ç—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Å–∏—Ç—É–∞—Ü–∏—é! –ü—Ä–µ–¥–ª–∞–≥–∞—é —Ç–∞–∫–∂–µ –ø—Ä–æ–π—Ç–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —É—Ä–æ–∫.';
                    } else {
                        message = '–°—É–ø–µ—Ä! –ù–∞ —Å–µ–≥–æ–¥–Ω—è —Ç—ã –º–æ–ª–æ–¥–µ—Ü - —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω –∏ —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!';
                    }
                    
                    speechBubble.innerHTML = `${message}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
                if (lessonCompleted) {
                    markCardCompleted(
                        document.getElementById('coursesCard'),
                        document.getElementById('coursesIndicator'),
                        new Date().toISOString().split('T')[0],
                        '–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'
                    );
                }
                
                if (journalCompleted) {
                    markJournalCompleted(
                        new Date().toISOString().split('T')[0],
                        '–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'
                    );
                }
            }
        });
    </script>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <script src="{{ url_for('static', filename='js/user-progress.js') }}"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userProgress;
        document.addEventListener('DOMContentLoaded', function() {
            userProgress = new UserProgress();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é markOnboardingCompleted
            function markOnboardingCompleted() {
                userProgress.markOnboardingCompleted();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é markCardCompleted
            function markCardCompleted(card, indicator, dateString, source) {
                if (card) {
                    card.classList.remove('active');
                    card.classList.add('completed');
                }
                
                if (indicator) {
                    indicator.classList.remove('active');
                    indicator.classList.add('completed');
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫" –µ—Å–ª–∏ —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω
                const journalIndicator = document.getElementById('journalIndicator');
                if (journalIndicator) {
                    journalIndicator.classList.add('active');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                userProgress.markLessonCompleted();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é markJournalCompleted
            function markJournalCompleted(dateString, source) {
                const journalCard = document.getElementById('journalCard');
                const journalIndicator = document.getElementById('journalIndicator');
                
                if (journalCard) {
                    journalCard.classList.remove('active');
                    journalCard.classList.add('completed');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.add('completed');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                userProgress.markJournalCompleted();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é resetLessonProgress
            window.resetLessonProgress = function() {
                userProgress.resetProgress();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                const coursesCard = document.getElementById('coursesCard');
                const coursesIndicator = document.getElementById('coursesIndicator');
                const journalIndicator = document.getElementById('journalIndicator');
                const journalCard = document.getElementById('journalCard');
                
                if (coursesCard) {
                    coursesCard.classList.remove('completed');
                    coursesCard.classList.add('active');
                }
                
                if (coursesIndicator) {
                    coursesIndicator.classList.remove('completed');
                    coursesIndicator.classList.add('active');
                }
                
                if (journalIndicator) {
                    journalIndicator.classList.remove('active');
                    journalIndicator.classList.remove('completed');
                }
                
                if (journalCard) {
                    journalCard.classList.remove('completed');
                    journalCard.classList.add('active');
                }
                
                console.log('–î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —É—Ä–æ–∫–∞ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ –æ—á–∏—â–µ–Ω—ã. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–±—Ä–æ—à–µ–Ω–æ.');
                return '–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–∫–∞ –∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω';
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            function checkTodayProgress() {
                const lessonCompleted = userProgress.isCompletedToday('lesson');
                const journalCompleted = userProgress.isCompletedToday('journal');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                const speechBubble = document.querySelector('.speech-bubble');
                if (speechBubble) {
                    let message = '';
                    let buttons = '';
                    
                    if (!lessonCompleted && !journalCompleted) {
                        message = '–ü—Ä–∏–≤–µ—Ç! –ù–∞—á–Ω–∏ —Å–≤–æ–π –¥–µ–Ω—å —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —É—Ä–æ–∫–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Ç—É–∞—Ü–∏–∏.';
                        buttons = `
                            <button class="action-button analyze-button" id="startLessonBtn">–ù–∞—á–∞—Ç—å —É—Ä–æ–∫</button>
                            <button class="action-button analyze-button" id="startJournalBtn">–°–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
                        `;
                    } else if (lessonCompleted && !journalCompleted) {
                        message = '–û—Ç–ª–∏—á–Ω–æ, —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω, –¥–∞–≤–∞–π—Ç–µ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–≤–æ–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫–µ.';
                        buttons = `
                            <button class="action-button analyze-button" id="startJournalBtn">–°–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
                        `;
                    } else if (!lessonCompleted && journalCompleted) {
                        message = '–ó–¥–æ—Ä–æ–≤–æ, —á—Ç–æ —Ç—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Å–∏—Ç—É–∞—Ü–∏—é! –ü—Ä–µ–¥–ª–∞–≥–∞—é —Ç–∞–∫–∂–µ –ø—Ä–æ–π—Ç–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —É—Ä–æ–∫.';
                        buttons = `
                            <button class="action-button analyze-button" id="startLessonBtn">–ù–∞—á–∞—Ç—å —É—Ä–æ–∫</button>
                        `;
                    } else {
                        message = '–°—É–ø–µ—Ä! –ù–∞ —Å–µ–≥–æ–¥–Ω—è —Ç—ã –º–æ–ª–æ–¥–µ—Ü - —É—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω –∏ —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!';
                    }
                    
                    speechBubble.innerHTML = `
                        ${message}
                        <div class="speech-bubble-actions">
                            ${buttons}
                        </div>
                    `;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
                    const startLessonBtn = document.getElementById('startLessonBtn');
                    const startJournalBtn = document.getElementById('startJournalBtn');
                    
                    if (startLessonBtn) {
                        startLessonBtn.addEventListener('click', function() {
                            window.location.href = '/courses';
                        });
                    }
                    
                    if (startJournalBtn) {
                        startJournalBtn.addEventListener('click', function() {
                            openChat();
                        });
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
                if (lessonCompleted) {
                    markCardCompleted(
                        document.getElementById('coursesCard'),
                        document.getElementById('coursesIndicator'),
                        new Date().toISOString().split('T')[0],
                        '–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'
                    );
                }
                
                if (journalCompleted) {
                    markJournalCompleted(
                        new Date().toISOString().split('T')[0],
                        '–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'
                    );
                }
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            checkTodayProgress();
        });
    </script>
</head>
<body>
    <div class="background-image"></div>
    <div class="parallax-image" id="parallaxImage"></div>

    <!-- –ü–ª–∞—à–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Ç –æ–±–ª–∞—á–∫–∞ -->
    <div class="speech-bubble"></div>

    <div class="container">
        <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π -->
        <div class="features-container">
            <div class="features-timeline"></div>
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –Ω–∞—Ä—É–∂—É –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="timeline-indicator" id="coursesIndicator"></div>
            <div class="timeline-indicator" id="journalIndicator"></div>
            
            <div class="feature-card" id="coursesCard" onclick="window.location.href='/courses'">
                <div class="feature-content">
                    <h2 class="feature-title">–ö—É—Ä—Å—ã –ø–æ –ö–ü–¢</h2>
                    <p class="feature-subtitle">–ò–∑—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤—ã –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏</p>
                </div>
                <div class="feature-image">
                    <img src="static/img/Cutesy_3D_asset_7dQCU2bWU1k15pJ3wEKvzsb6_A_man_stands_with_his_back (1).png" alt="–ö—É—Ä—Å—ã">
                </div>
            </div>
            
            <div class="feature-card" id="journalCard" style="position: relative; overflow: hidden;">
                <div class="feature-content">
                    <h2 class="feature-title">–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</h2>
                    <p class="feature-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</p>
                </div>
                <div class="feature-image">
                    <img src="static/img/Cutesy_3D_asset_tBxQ6vN6ZJ6Qdwn3JShaGXTP_simple_still_life_composition (1).png" alt="–ï–∂–µ–¥–Ω–µ–≤–Ω–∏–∫">
                </div>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è -->
        <div class="streak-container">
            <div class="streak-title">–í–∞—à –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è</div>
            <div class="mood-calendar" id="moodCalendar">
                <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="content" style="display: none;">
        </div>
    </div>
    
    <!-- –û–≤–µ—Ä–ª–µ–π —á–∞—Ç–∞ -->
    <div class="chat-overlay" id="chatOverlay">
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ -->
        <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <button class="chat-close-button" id="chatCloseButton">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2 class="chat-title">–£–º–Ω—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–∏–∫</h2>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <div class="chat-input-container">
            <input type="text" id="userInput" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button id="sendButton" class="chat-send-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>
    </div>
</body>
</html> 